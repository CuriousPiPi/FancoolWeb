{% extends "base.html" %}

{% block body_content %}
  {% include "partials/modals.html" %}

  <!-- 左上角浮动侧栏按钮 -->
  <button id="sidebar-toggle" class="sidebar-fab-toggle" aria-label="展开侧栏" title="展开/收起侧栏">
    <span class="icon-sidebar" aria-hidden="true"></span>
  </button>

  {% include "partials/sidebar.html" %}

  <!-- 主内容 -->
  <main id="main-content">
    <div class="container mx-auto px-4 py-8">
      <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-blue-600 mb-2">风扇库</h1>
        <p class="text-gray-600">一个风扇性能可视化对比网站，选择参数并添加到图表</p>
        <div class="mt-2 text-sm text-gray-500">
          总查询次数：<span id="query-count">{{ query_count or 0 }}</span>
        </div>
      </header>

      <!-- 工具栏 -->
      <div style="position: fixed; top: 20px; right: 100px; z-index: 1000;">
        <a href="#" class="info-source-btn bg-white text-gray-700 hover:text-blue-600 p-2 rounded-full shadow-md border border-gray-200 flex items-center justify-center" 
           title="数据来源与说明(待开发)" aria-label="数据来源说明">
          <i class="fa-solid fa-circle-info text-lg"></i>
        </a>
      </div>
      <div class="theme-toggle" id="themeToggle" title="切换深浅色" aria-label="切换主题">
        <i class="fa-solid fa-moon" id="themeIcon"></i>
      </div>

      <div class="flex flex-col lg:flex-row gap-6 mb-8">
        <!-- 左侧添加/搜索区域 -->
        <div class="bg-white rounded-xl shadow-md p-6 lg:w-1/3">
          <nav class="tab-nav" data-tab-group="left-panel">
            <div class="tab-nav-item active" data-tab="add-by-model" role="tab" aria-selected="true" tabindex="0">按型号添加</div>
            <div class="tab-nav-item" data-tab="filter-by-scenario" role="tab" aria-selected="false" tabindex="-1">按负载场景筛选</div>
          </nav>
          
          <div class="tab-content-container" id="left-panel-container">
            <div class="tab-content-wrapper" id="left-tabs-wrapper">
              <!-- 按型号添加 -->
              <div class="tab-pane" id="add-by-model-pane" role="tabpanel">
                <form id="fanForm" class="form-grid">
                  <div class="form-row">
                    <label for="modelSearchInput" class="block text-sm font-medium">输入型号直接搜索</label>
                    <div class="relative">
                      <input type="text" id="modelSearchInput" class="ui-field w-full border-gray-300" 
                             placeholder="输入型号关键字..." aria-describedby="search-help">
                      <div id="searchSuggestions" class="absolute z-10 hidden bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto w-full mt-1"></div>
                    </div>
                    <small id="search-help" class="text-gray-500 text-xs">直接输入型号进行快速搜索</small>
                  </div>

                  <div class="form-row">
                    <label for="brandSelect" class="block text-sm font-medium">品牌</label>
                    <select id="brandSelect" class="ui-field w-full border-gray-300">
                      <option value="">-- 选择品牌 --</option>
                      {% for brand in brands %}
                        <option value="{{ brand }}">{{ brand }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="form-row">
                    <label for="modelSelect" class="block text-sm font-medium">型号</label>
                    <select id="modelSelect" class="ui-field w-full border-gray-300" disabled>
                      <option value="">-- 选择型号 --</option>
                    </select>
                    <div id="modelLoading" class="text-sm text-gray-500 mt-1 hidden">加载中...</div>
                  </div>

                  <div class="form-row">
                    <label for="resTypeSelect" class="block text-sm font-medium">风阻类型</label>
                    <select id="resTypeSelect" class="ui-field w-full border-gray-300" disabled>
                      <option value="">-- 选择风阻类型 --</option>
                      <option value="全部">全部</option>
                    </select>
                    <div id="resTypeLoading" class="text-sm text-gray-500 mt-1 hidden">加载中...</div>
                  </div>

                  <div class="form-row">
                    <label for="resLocSelect" class="block text-sm font-medium">风阻位置</label>
                    <select id="resLocSelect" class="ui-field w-full border-gray-300" disabled>
                      <option value="">-- 选择风阻位置 --</option>
                      <option value="全部">全部</option>
                    </select>
                    <div id="resLocLoading" class="text-sm text-gray-500 mt-1 hidden">加载中...</div>
                  </div>

                  <div class="form-row">
                    <button type="submit" class="w-full ui-btn success" style="font-size: 16px;" aria-label="添加选中的风扇到图表">
                      添加至图表
                    </button>
                  </div>
                </form>
              </div>

              <!-- 按负载场景筛选 -->
              <div class="tab-pane" id="filter-by-scenario-pane" role="tabpanel">
                <form id="searchForm" class="form-grid">
                  <div class="form-row">
                    <label class="block text-sm font-medium">风阻类型</label>
                    <select name="search_res_type" class="ui-field w-full border-gray-300">
                      <option value="">-- 选择风阻类型 --</option>
                      {% for type in all_res_types %}
                        <option value="{{ type }}" {% if search_res_type == type %}selected{% endif %}>{{ type }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="form-row">
                    <label class="block text-sm font-medium">风阻位置</label>
                    <select name="search_res_loc" class="ui-field w-full border-gray-300">
                      <option value="">-- 选择风阻位置 --</option>
                      {% for loc in all_res_locs %}
                        <option value="{{ loc }}" {% if search_res_loc == loc %}selected{% endif %}>{{ loc }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="form-row">
                    <label class="block text-sm font-medium">尺寸(mm)</label>
                    <select name="size_filter" class="ui-field w-full border-gray-300">
                      {% for size in size_options %}
                        <option value="{{ size }}" {% if size_filter == size %}selected{% endif %}>{{ size }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="form-row">
                    <button type="submit" id="searchBtn" class="w-full ui-btn" style="font-size: 16px;" aria-label="搜索符合条件的风扇">
                      搜索
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- 右侧排行榜区域 -->
        <div class="bg-white rounded-xl shadow-md p-6 lg:w-2/3 right-panel-card" id="right-panel-wrapper">
          <nav class="tab-nav" data-tab-group="right-panel">
            <div class="tab-nav-item active" data-tab="top-queries" role="tab" aria-selected="true" tabindex="0">热门查询</div>
            <div class="tab-nav-item" data-tab="search-results" role="tab" aria-selected="false" tabindex="-1">搜索结果</div>
          </nav>
          
          <div class="tab-content-container" id="right-panel-container">
            <div class="tab-content-wrapper" id="right-tabs-wrapper">
              <!-- 热门查询 -->
              <div class="tab-pane" id="top-queries-pane" role="tabpanel">
                {% include "partials/ranking.html" %}
              </div>

              <!-- 搜索结果 -->
              <div class="tab-pane" id="search-results-pane" role="tabpanel">
                <div class="mb-3">
                  <div class="seg" data-active="search-airflow-panel" role="tablist" aria-label="排序视图切换">
                    <button class="seg-btn is-active" data-target="search-airflow-panel" role="tab" aria-selected="true" aria-controls="search-airflow-panel">风量优先</button>
                    <button class="seg-btn" data-target="search-likes-panel" role="tab" aria-selected="false" aria-controls="search-likes-panel">好评优先</button>
                    <span class="seg-thumb"></span>
                  </div>
                </div>

                <div class="rank-content-box">
                  <div id="searchConditionLabel" class="condition-label text-sm text-gray-600 mb-3"></div>

                  <div class="rank-panel active" id="search-airflow-panel" role="tabpanel">
                    <div class="rank-table-scroll">
                      <table class="ranking-table">
                        <thead>
                          <tr>
                            <th>品牌</th>
                            <th>型号</th>
                            <th>尺寸</th>
                            <th>负载场景</th>
                            <th>转速(RPM)</th>
                            <th>噪音(dB)</th>
                            <th class="add-header">添加</th>
                          </tr>
                        </thead>
                        <tbody id="searchAirflowTbody">
                          <tr><td colspan="7" class="text-center text-gray-500 py-6">使用左侧筛选功能搜索风扇</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="rank-panel" id="search-likes-panel" role="tabpanel">
                    <div class="rank-table-scroll">
                      <table class="ranking-table">
                        <thead>
                          <tr>
                            <th>品牌</th>
                            <th>型号</th>
                            <th>尺寸</th>
                            <th>负载场景</th>
                            <th>转速(RPM)</th>
                            <th>噪音(dB)</th>
                            <th class="add-header">添加</th>
                          </tr>
                        </thead>
                        <tbody id="searchLikesTbody">
                          <tr><td colspan="7" class="text-center text-gray-500 py-6">使用左侧筛选功能搜索风扇</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% include "partials/chart.html" %}
    </div>
  </main>

  <script>
    /* 全局配置（后端注入） */
    window.APP_CONFIG = {
      clickCooldownMs: {{ click_cooldown_ms|default(2000) }},
      maxItems: {{ max_chart_items }}
    };
  </script>
{% endblock %}