<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <link rel="icon" type="image/png" href="/static/logo.png">
  <script>
    (function () {
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>风扇库</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome 6.5.2 -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
        
<style>
  /* ========== 基础设置 ========== */
  html { font-size: 16px; }

  /* ========== 自定义变量（集中管理） ========== */
  :root {
    --bg-primary:#f9fafb;
    --bg-secondary:#ffffff;
    --text-primary:#1f2937;
    --text-secondary:#4b5563;
    --border-color:#e5e7eb;
    --shadow-color:rgba(0,0,0,0.12);
    --transition-speed:0.28s;

    --toast-bg:#ffffff;
    --toast-border:#e5e7eb;
    --toast-text:#1f2937;
    --toast-success:#059669;
    --toast-error:#dc2626;
    --toast-loading:#2563eb;

    --control-height:46px;
    --control-radius:10px;
    --control-h-padding:14px;
    --control-btn-h-padding:18px;
    --form-row-gap:16px;

    --brand-green:#10B981;
    --brand-green-hover:#0ea373;
    --brand-green-dark:#198f63;
    --brand-green-dark-hover:#147452;
    --danger:#dc2626;
    --danger-hover:#b91c1c;
    --primary:#2563eb;
    --primary-hover:#1d4ed8;
    --primary-dark:#194ec0;
    --muted:#6b7280;

    --content-left-gutter: 25px;
    --content-right-gutter: 25px;
    --content-bottom-gap: 12px;
    --bottom-title-gap: 10px;
    --bottom-title-top-pad: 4px;
    --header-divider-offset: 8px;

    --sidebar-footer-h: 32px;
    --footer-v-pad: 16px;
    --sbw: 16px; /* 滚动条预估宽度（Windows/Chrome 约 15~17px） */

    --item-like-w: 24px;
    --item-remove-w: 16px;
    --item-actions-gap: 12px;

    --action-restore-col-w: 16px;
    --action-like-col-w: 24px;
    --action-add-col-w: 16px;
    --action-gap: 12px;

    /* 分隔条上下死区 */
    --sidebar-splitter-up-deadzone: 0; 
    --sidebar-splitter-down-deadzone: 0;

    --seg-btn-w: 80px; /* 子页签切换控件宽度 */

    /* Gesture Close Zone: Default 24px (user-adjustable). Increase if users have difficulty triggering edge swipe. */
    --gesture-close-zone-width: 24px;
  }

  /* 暗色主题变量 */
  [data-theme="dark"] {
    --bg-primary:#111827;
    --bg-secondary:#1f2937;
    --text-primary:#f3f4f6;
    --text-secondary:#d1d5db;
    --border-color:#374151;
    --shadow-color:rgba(0,0,0,0.55);

    --toast-bg:#1f2937;
    --toast-border:#374151;
    --toast-text:#f3f4f6;
  }

  /* ========== 全局基础样式 ========== */
  html, body { height:100%; overflow-x:hidden; }
  body {
    background:var(--bg-primary)!important;
    color:var(--text-primary);
    transition:background .3s,color .3s;
    font-family:system-ui,-apple-system,"Segoe UI","Helvetica Neue","Microsoft YaHei",Arial,sans-serif;
  }

  .bg-white { background:var(--bg-secondary)!important; }
  .text-gray-600,.text-gray-500,.text-gray-700 { color:var(--text-secondary)!important; }
  .border-gray-200,.border-gray-300 { border-color:var(--border-color)!important; }
  .shadow-md { box-shadow:0 4px 10px var(--shadow-color)!important; }

  a, button { color:var(--text-primary); }

  .form-grid { display:grid; grid-template-columns: 1fr; row-gap: var(--form-row-gap); }
  .form-row label { display:block; margin-bottom:6px; font-size:14px; }

  .ui-field,
  .ui-btn,
  .ui-select {
    box-sizing:border-box;
    height:var(--control-height)!important;
    padding:0 var(--control-h-padding)!important;
    border:1px solid var(--border-color);
    border-radius:var(--control-radius);
    background-color:var(--bg-secondary);
    color:var(--text-primary);
    font-size:14px;
    line-height:1;
    display:inline-flex;
    align-items:center;
    font-weight:500;
    transition:.2s;
  }

  select.ui-field {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-color: var(--bg-secondary);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%234b5563' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 14px 14px;
    padding-right: 40px !important;
  }
  [data-theme="dark"] select.ui-field {
    background-color: var(--bg-secondary) !important;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23d1d5db' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") !important;
    background-repeat: no-repeat !important;
    background-position: right 12px center !important;
    background-size: 14px 14px !important;
    padding-right: 40px !important;
  }
  select.ui-field::-ms-expand { display: none; }

  .ui-field:focus,
  .ui-select:focus,
  .ui-btn:focus {
    outline:none;
    border-color:var(--primary);
    box-shadow:0 0 0 2px rgba(59,130,246,.35);
  }

  .ui-btn {
    cursor:pointer;
    padding:0 var(--control-btn-h-padding)!important;
    justify-content:center;
    background:var(--primary);
    color:#fff;
    border-color:var(--primary);
    font-weight:600;
    letter-spacing:.5px;
    font-size:14px;
  }
  .ui-btn:hover { background:var(--primary-hover); }
  .ui-btn:active { background:var(--primary-dark); }

  .ui-btn.success {
    background:var(--brand-green)!important;
    border-color:var(--brand-green)!important;
    color:#fff!important;
  }
  .ui-btn.success:hover { background:var(--brand-green-hover)!important; border-color:var(--brand-green-hover)!important; }
  .ui-btn.secondary {
    background:var(--danger)!important;
    border-color:var(--muted)!important;
    color:#fff!important;
  }
  .ui-btn.secondary:hover { background:var(--danger-hover)!important; border-color:var(--muted)!important; }

  input.ui-field, select.ui-field { -webkit-appearance:none; appearance:none; }
  input.ui-field::-webkit-inner-spin-button, input.ui-field::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
  input.ui-field[type=number] { -moz-appearance:textfield; }

  [data-theme="dark"] .ui-field,
  [data-theme="dark"] .ui-select {
    background-color:var(--bg-secondary)!important;
    border-color:var(--border-color)!important;
    color:var(--text-primary)!important;
  }
  [data-theme="dark"] .ui-btn { color:#fff!important; }
  [data-theme="dark"] .ui-btn:not(.secondary):not(.success) {
    background:var(--primary)!important;
    border-color:var(--primary)!important;
  }
  [data-theme="dark"] .ui-btn:not(.secondary):not(.success):hover {
    background:var(--primary-dark)!important;
    border-color:var(--primary-dark)!important;
  }
  [data-theme="dark"] .ui-btn.secondary { background:var(--danger)!important; border-color:var(--muted)!important; }
  [data-theme="dark"] .ui-btn.secondary:hover { background:var(--danger-hover)!important; }
  [data-theme="dark"] .ui-btn.success { background:var(--brand-green-dark)!important; border-color:var(--brand-green-dark)!important; }
  [data-theme="dark"] .ui-btn.success:hover { background:var(--brand-green-dark-hover)!important; }

  .btn-add {
    background:transparent!important;
    color:var(--brand-green)!important;
    width:auto; height:auto;
    border:none; border-radius:6px;
    padding:4px;
    display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer; transition:color .2s, transform .2s;
    box-shadow:none;
    font-size:14px;
  }
  .btn-add i { font-size:18px; line-height:1; }
  .btn-add:hover { transform:translateY(-1px); color:var(--brand-green-hover)!important; }
  .btn-add[data-mode="remove"] { color:var(--danger)!important; }
  .btn-add[data-mode="remove"]:hover { color:var(--danger-hover)!important; }
  [data-theme="dark"] .btn-add { color:var(--brand-green-dark)!important; }
  [data-theme="dark"] .btn-add:hover { color:var(--brand-green-dark-hover)!important; }
  [data-theme="dark"] .btn-add[data-mode="remove"] { color:var(--danger)!important; }
  [data-theme="dark"] .btn-add[data-mode="remove"]:hover { color:#ef4444!important; }

  .restore-icon { color:var(--brand-green)!important; }
  .restore-icon:hover { color:var(--brand-green-hover)!important; }
  [data-theme="dark"] .restore-icon { color:var(--brand-green-dark)!important; }
  [data-theme="dark"] .restore-icon:hover { color:var(--brand-green-dark-hover)!important; }

  /* ========== 侧边栏与滚动 ========== */
  #top-panel .tab-nav {
    position: sticky;
    top: calc(-1 * var(--header-divider-offset)) !important;                 /* 原先是 calc(-1 * var(--sp-pad-top)) */
    z-index: 60;
    background: var(--bg-secondary);
    /* 原样式中的 margin/padding 由下一条细化规则负责，这里不额外设定 */
    box-shadow: none;          /* 取消内阴影线，底线改用 ::after */
    border-bottom: 0;          /* 不再通栏画底线 */
  }
  
    /* ========== 侧边栏页签 ========== */

  .tab-nav { display:flex; border-bottom:2px solid var(--border-color); margin-bottom:1rem; gap:.5rem; }
  .tab-nav.with-subseg { justify-content:space-between; align-items:center; gap:1rem; }
  .tab-nav-item {
    padding:.7rem 1.2rem;
    cursor:pointer;
    font-weight:700;
    color:var(--text-secondary);
    border-bottom:2px solid transparent;
    margin-bottom:-2px;
    transition:.25s;
    user-select:none;
    font-size:16px;
    letter-spacing:.5px;
  }
  .tab-nav-item:hover { color:var(--text-primary); }
  .tab-nav-item.active { color:#3B82F6; border-bottom-color:#3B82F6; }
  #top-panel .tab-nav .tab-nav-item {
    margin-bottom: 0 !important;
  }
  #top-panel .tab-nav .tab-nav-item.active { border-bottom-color: #3B82F6 !important; z-index: 60; }

  /* P0：两个页签等分全宽（侧栏上半区 + 左侧添加/筛选） */
  .tab-nav[data-tab-group="sidebar-top"],
  .tab-nav[data-tab-group="left-panel"] {
    /* 保留 flex 布局，只是去掉间距，避免视觉断裂 */
    gap: 0 !important;
  }
  .tab-nav[data-tab-group="sidebar-top"] .tab-nav-item,
  .tab-nav[data-tab-group="left-panel"] .tab-nav-item {
    flex: 1 1 0;          /* 等分宽度 */
    text-align: center;   /* 文案居中 */
  }


  #sidebar {
    position:fixed; top:0; left:0; height:100vh; width:450px;
    background:var(--bg-secondary);
    border-right:1px solid var(--border-color);
    box-shadow:2px 0 10px var(--shadow-color);
    z-index:50; display:flex; flex-direction:column;
    transform:translateX(0);
    transition:transform var(--transition-speed) ease, width .12s ease;
    overflow:hidden;
  }
  #sidebar.collapsed { transform:translateX(-100%); }
  #main-content { margin-left:0; transition:margin-left var(--transition-speed) ease; }

  #top-panel .sidebar-panel-content {
    overflow-y: hidden !important;
    overflow-x: hidden !important;
  }

  .sidebar-panel { display:flex; flex-direction:column; overflow:hidden; }
  .sidebar-panel-content {
    --sp-pad-top: 8px;
    --sp-pad-x: 0;
    --sp-pad-bottom: 24px;
    flex-grow:1;
    padding: var(--sp-pad-top) var(--sp-pad-x) var(--sp-pad-bottom);
    scrollbar-color: var(--border-color) var(--bg-secondary);
  }    
  #bottom-panel { transition:flex-basis .35s ease, height .35s ease; }


  /* 分隔条：上下 1px 细线，避免被相邻内容“吃边”*/
  #sidebar-splitter {
    position: relative;
    height: 12px;
    background: var(--bg-primary);
    border: 0;
    z-index: 200;
    isolation: isolate;
    box-shadow: none;
  } 

  /* 中间把手（按钮/触摸热区） */
  #sidebar-splitter .splitter-handle {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    width: 72px;
    height: 24px;
    border-radius: 9999px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 2px rgba(0,0,0,.08);
    cursor: ns-resize;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    touch-action: none;         /* 允许我们接管垂直拖拽 */
    user-select: none;
    -webkit-user-select: none;
    pointer-events: auto;
  }

  /* 把手上的“抓手纹” */
  #sidebar-splitter .splitter-handle::before {
    content: "";
    width: 26px;
    height: 10px;
    border-radius: 9999px;
    background:
      repeating-linear-gradient(
        to bottom,
        var(--border-color) 0px, var(--border-color) 1px,
        transparent 1px, transparent 4px
      );
    opacity: .75;
  }

  #sidebar-splitter .splitter-handle:hover {
    border-color: #93c5fd; /* 可按需调整主题色 */
    box-shadow: 0 1px 3px rgba(0,0,0,.12);
  }
  #sidebar-splitter .splitter-handle:active {
    transform: translate(-50%,-50%) scale(.98);
  }

  /* 触摸设备上增大可触区 */
  @media (hover: none) and (pointer: coarse) {
    #sidebar-splitter .splitter-handle {
      width: 92px;
      height: 30px;
    }
  }

  #sidebar-resizer {
    position:absolute; top:0; right:0; width:6px; height:100%;
    cursor:ew-resize; z-index:70; pointer-events:auto;
    touch-action: none;
  }
  #sidebar-resizer:hover { background:rgba(0,0,0,.08); }

  
  .tab-content-container { overflow:hidden; position:relative; min-height:460px; }
  .tab-content-wrapper { display:flex; width:200%; transition:transform .45s cubic-bezier(.4,0,.2,1); }
  .tab-pane { width:50%; flex-shrink:0; padding:0 2px; }

  .right-subseg { display:flex; align-items:center; gap:.5rem; min-height:42px; }
  .right-subseg .seg { margin:0; }

  .seg { position:relative; display:inline-flex; gap:0; padding:3px; border:1px solid var(--border-color); border-radius:9999px; background:var(--bg-secondary); }
  .seg-btn { position:relative; z-index:1; padding:6px 12px; border-radius:9999px; font-weight:600; color:var(--text-secondary); background:none; border:none; cursor:pointer; transition:.2s; font-size:13px; }
  .seg-btn.is-active { color:var(--text-primary); }
  .seg-thumb { position:absolute; inset:3px auto 3px 3px; width:calc(50% - 3px); border-radius:9999px; background:rgba(59,130,246,.12); transition:transform .25s ease; }
  .seg[data-active$="likes-panel"] .seg-thumb { transform:translateX(100%); }
  [data-theme="dark"] .seg-thumb { background:rgba(95,163,255,.14); }

  .rank-panel { display:none; animation:fadePanel .25s ease; }
  .rank-panel.active { display:block; }
  @keyframes fadePanel { from { opacity:0; transform:translateY(8px);} to {opacity:1; transform:translateY(0);} }

  .rank-table-scroll { max-height:360px; overflow:auto; padding-top:0; background:var(--bg-secondary); scrollbar-gutter: stable both-edges; }
  .rank-table-scroll::-webkit-scrollbar { width:8px; }
  .rank-table-scroll::-webkit-scrollbar-thumb { background:var(--border-color); border-radius:4px; }
  .rank-table-scroll::-webkit-scrollbar-thumb:hover { background:var(--text-secondary); }

  .ranking-table { width:100%; border-collapse:separate; border-spacing:0; }
  .ranking-table th, 
  .ranking-table td { padding:.6rem; vertical-align:middle; font-size:14px; }
  .ranking-table th { text-align:left; white-space:nowrap; font-weight:600; letter-spacing:.5px; }
  .ranking-table th:last-child, 
  .ranking-table td:last-child { 
    text-align:center; 
    width:60px; 
    position: sticky; 
    z-index: ; 
    right: 0;   
    background: var(--bg-secondary); 
  }
  .ranking-table td:last-child { padding: 8px; }
  .rank-cell, .ranking-table th.rank-header { width:56px; text-align:center; }
  .ranking-table thead th {
    position:sticky; top:0; z-index:8;
    background:var(--bg-secondary);
    box-shadow:0 2px 3px -1px rgba(0,0,0,.08);
  }
  [data-theme="dark"] .ranking-table thead th {
    background:var(--bg-secondary);
    box-shadow:0 2px 3px -1px rgba(0,0,0,.45);
  }
  .right-panel-card .ranking-table thead th:last-child {
    top: 0;                        /* 已有 sticky 表头，这里确保最后一列也顶住 */
    z-index: 11;
    /* 顶部表头已有下阴影，这里补一条列分隔线以衔接表体 */
    box-shadow:
      0 2px 3px -1px rgba(0,0,0,.45);
  }

  .right-panel-card .ranking-table td:last-child {
  background: linear-gradient(to left,
      var(--bg-secondary) 30px,    /* 靠右侧为容器同色 */
      rgba(0,0,0,0) 50px           /* 向左过渡到透明 */
      );
}

  /* 右缘遮罩，彻底盖住缝/滚动条 */
  .right-panel-card .rank-content-box { position: relative; }
  .right-panel-card .rank-content-box::after {
    content: "";
    position: absolute;
    top: 0;
    right: -2px;                        /* 固定贴住卡片右缘，不随内容滚动 */
    bottom: 0;
    width: calc(var(--sbw) + 3px);   /* 滚动条宽 + 1px，兜底消除子像素缝 */
    background: var(--bg-secondary);
    pointer-events: none;
    z-index: 20;                     /* 盖过表格 */
  }

  .ranking-table tr:hover { background:rgba(60,120,255,.05); }
  [data-theme="dark"] .ranking-table tr:hover { background:#2a3545!important; }
  .ranking-table .fa-medal.gold { color:#FFD700!important; }
  .ranking-table .fa-medal.silver { color:#C0C0C0!important; }
  .ranking-table .fa-medal.bronze { color:#CD7F32!important; }

  #right-panel-wrapper .ranking-table th, #right-panel-wrapper .ranking-table td { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .marquee-cell { overflow:hidden; }
  .marquee-inner { display:inline-block; will-change:transform; }

  /* === 主题切换按钮 === */
  .theme-toggle {
   position:fixed; top:10px; right:25px; z-index:1000;
   background:var(--bg-secondary); border:1px solid var(--border-color);
   display:flex; align-items:center; justify-content:center;
   cursor:pointer; box-shadow:0 2px 6px var(--shadow-color);
   width: 44px;
   height: 44px;
   border-radius: 50%;
   transition: background .25s, transform .25s;
  }
  .theme-toggle:active {
   transform: scale(0.95);
  }

   
  #toastContainer {
    position:fixed; top:12px; left:50%; transform:translateX(-50%);
    z-index:2000; display:flex; flex-direction:column; gap:10px;
    width:clamp(260px, 60vw, 520px); pointer-events:none;
  }
  .toast {
    background:var(--toast-bg); color:var(--toast-text);
    border:1px solid var(--toast-border);
    box-shadow:0 4px 12px rgba(0,0,0,0.18);
    padding:.75rem 1rem; border-radius:10px;
    font-size:14px; line-height:1.3;
    display:flex; align-items:flex-start; gap:.6rem;
    opacity:0; transform:translateY(-8px);
    animation:toast-in .35s cubic-bezier(.4,0,.2,1) forwards;
    pointer-events:auto; position:relative;
  }
  .toast.success { border-color:var(--toast-success); }
  .toast.error { border-color:var(--toast-error); }
  .toast.loading { border-color:var(--toast-loading); }
  .toast .close-btn { position:absolute; top:4px; right:8px; cursor:pointer; font-weight:600; }
  @keyframes toast-in { to { opacity:1; transform:translateY(0); } }
  @keyframes toast-out { to { opacity:0; transform:translateY(-6px); } }

  .condition-label { font-size:14px; color:#555; margin:4px 0 8px 2px; line-height:1.3; opacity:.9; letter-spacing:.5px; font-weight:500; }
  [data-theme="dark"] .condition-label { color:var(--text-secondary); }

  .remove-icon { color:#dc2626!important; }
  .remove-icon:hover { color:#b91c1c!important; }

  .clear-confirm-wrapper { display:flex; gap:.5rem; }
  .clear-confirm-wrapper button { flex:1; font-size:14px; padding:.55rem .75rem; border-radius:8px; font-weight:500; }

  .tooltip-btn[title] { position:relative; }

  #sidebar .fan-item .truncate > .font-medium { font-size:14px; }

  .right-panel-card { display:flex; flex-direction:column; }
  .right-panel-card .tab-content-container { flex:1; min-height:0; }
  .right-panel-card .tab-pane { height:100%; display:flex; flex-direction:column; }
  .right-panel-card .rank-content-box { flex:1; min-height:0; padding-top: 0;}
  .right-panel-card .rank-panel { display:none; }
  .right-panel-card .rank-panel.active { display:flex; flex-direction:column; flex:1; min-height:0; }
  .right-panel-card .rank-table-scroll { flex:1; max-height:none; overflow:auto; }
  .right-panel-card > nav.tab-nav.with-subseg { margin-bottom: 6px;} /* 原为 1rem，可按需调成 0~8px */

  #sidebar .fan-item .truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #sidebar .fan-item .sidebar-marquee-inner {
    display: inline-block;
    will-change: transform;
    transition: transform .35s ease;
  }

  #searchSuggestions {
    font-size:14px;
    line-height:1.4;
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
  }
  #searchSuggestions > div { padding: 8px 12px; }
  #searchSuggestions > div:hover { background: rgba(59,130,246,.08); }
  [data-theme="dark"] #searchSuggestions > div:hover { background:#2a3545; }

  #top-panel #recentlyRemovedList,
  #top-panel #recentLikesList {
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
    /*overscroll-behavior: contain;*/
    padding-left: var(--content-left-gutter) !important;
    padding-right: max(0px, calc(var(--content-right-gutter) - var(--sbw))) !important;
    margin-right: 0 !important;
    padding-top: var(--content-bottom-gap);
    scrollbar-gutter: stable;
  }

  #sidebar-header { padding:14px 18px 10px; position: relative; border-bottom: none !important; }
  #sidebar-header::after {
    content: ""; position: absolute; left: 0; right: 0; bottom: 0;
    height: 1px; background: var(--border-color); pointer-events: none;
  }

  #top-panel #recentlyRemovedList .fan-item {
    display: grid !important;
    grid-template-columns: 1fr var(--action-restore-col-w);
    align-items: center;
    column-gap: var(--action-gap);
  }
  #top-panel #recentlyRemovedList .fan-item .truncate { min-width: 0; }
  #top-panel #recentlyRemovedList .fan-item .restore-icon {
    width: var(--action-restore-col-w) !important;
    display: flex !important;
    justify-content: center !important;
    margin: 0 !important;
  }

  #top-panel .recent-like-group .actions {
    display: grid !important;
    grid-template-columns: var(--action-like-col-w) var(--action-add-col-w);
    column-gap: var(--action-gap);
    justify-content: end;
    align-items: center;
    pointer-events: auto;
    position: relative;
    z-index: 1;
  }
  #top-panel .recent-like-group .actions .like-button {
    width: var(--action-like-col-w) !important;
    display: flex !important;
    justify-content: center !important;
    margin: 0 !important;
  }
  #top-panel .recent-like-group .actions .btn-add {
    width: var(--action-add-col-w) !important;
    display: flex !important;
    justify-content: center !important;
    margin: 0 !important;
    height: 28px; padding: 0;
  }
  .recent-like-group .scenario-row .fa-thumbs-up {
    font-size: 16px;
    line-height: 1;
    width: 20px;
    text-align: center;
  }

  #bottom-panel {
    display: grid !important;
    grid-template-rows: auto 1fr auto !important;
    min-height: 0 !important;
  }
  
  #bottom-panel .sidebar-panel-content {
  grid-row: 1 / 3 !important;
  display: grid !important;
  grid-template-rows: auto 1fr !important;
  min-height: 0 !important;
  padding-left: 0 !important;   /* 25px */
  padding-right: 0 !important; /* 25px */
  padding-bottom: 0 !important;
  padding-top: 0 !important;
}

  #bottom-panel .sidebar-panel-content > h2 {
  position: sticky;
  padding-top: calc(1 * var(--sp-pad-top));
  z-index: 60;
  background: var(--bg-secondary);
  border: 0;
  box-shadow: none;
  margin: 0 !important;
  padding-left: var(--content-left-gutter) !important;
  padding-right: var(--content-right-gutter) !important;
  margin-bottom: var(--bottom-title-gap) !important;
}

  #selectedFansList {
    grid-row: 2 !important;
    min-height: 0 !important;
    overflow-y: auto !important;
    padding-left: var(--content-left-gutter) !important;
    padding-right: max(0px, calc(var(--content-right-gutter) - var(--sbw))) !important;
    padding-bottom: var(--content-bottom-gap) !important;
    margin-right: 0 !important;
    scrollbar-gutter: stable;
  }

  #clearAllContainer.sticky-footer {
    position: static !important;
    grid-row: 3 !important;
    bottom: 0 !important;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    padding: var(--footer-v-pad) var(--content-left-gutter) var(--footer-v-pad) var(--content-left-gutter) !important;
    display: flex; align-items: center; justify-content: center;
    pointer-events: auto; z-index: 10;
  }

  #clearAllContainer #clearAllBtn {
    transform: none !important;
    margin: 0 !important;
    width: 100% ;
  }

  #selectedFansList .flex.items-center.flex-shrink-0 {
    display: grid !important;
    grid-template-columns: var(--item-like-w) var(--item-remove-w);
    column-gap: var(--item-actions-gap);
    justify-content: end;
    align-items: center;
    min-width: calc(var(--item-like-w) + var(--item-remove-w) + var(--item-actions-gap));
  }
  #selectedFansList .like-button {
    width: var(--item-like-w) !important;
    margin-right: 0 !important;
    display: flex; justify-content: center; align-items: center;
  }
  #selectedFansList .remove-icon {
    width: var(--item-remove-w) !important;
    display: flex; justify-content: center; align-items: center;
  }
  #selectedFansList .like-button i,
  #selectedFansList .remove-icon i {
    width: 1em; text-align: center; line-height: 1;
  }

  .chart-container { 
    position: relative !important;
    min-height: 0 !important; /* 覆盖旧的 min-height:600px */ 
    height: clamp(480px, 62vh, 720px) !important; /* 可按需调整整体高度策略 */
    background:var(--bg-secondary)!important; 
  }
  /* 图表根与 iframe 高度占满容器 */
  #chartRoot { height: 100% !important; }
  #chartFrame { height: 100% !important; display: block; }


  #sidebar-top-container {
    overflow-x: auto !important;
    overflow-y: hidden !important;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    /*touch-action: pan-x pan-y;*/
    scrollbar-width: none;
    position: relative;
    width: 100%;
    height: 200px;
  }
 

  #sidebar-top-wrapper {
    display: flex ;
    width: auto ;
    min-width: 100%;
    height: 100% ;
    transform: none ;
    transition: none ;
  }

  #sidebar-top-wrapper .tab-pane {
    flex: 0 0 100% ;
    width: 100% ;
    height: 100% ;
    scroll-snap-align: start;
    scroll-snap-stop: always;
    display: flex;
    flex-direction: column;
    min-height: 0;
    padding-left: 0 ; 
    padding-right: 0 ;
  }

  #left-panel-container {
    overflow-x: auto ;
    overflow-y: visible ;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-x: contain;
    overscroll-behavior-y: auto;
    scrollbar-width: none;
    touch-action: pan-x pan-y;
  }
  #left-panel-container::-webkit-scrollbar { display: none; }

  #left-panel-wrapper {
    display: flex ;
    width: auto ;
    min-width: 100%;
    height: 100% ;
    transform: none ;
    transition: none ;
  }
  #left-panel-wrapper .tab-pane {
    flex: 0 0 100% ;
    width: 100% ;
    scroll-snap-align: start;
    scroll-snap-stop: always;
  }

  /* ===== Overlay 全屏模式 ===== */
  .sidebar-overlay-mode #sidebar {
    width:100vw ;
    max-width:100vw ;
    left:0; top:0; height:100vh;
    transform:translateX(-100%);
    transition:transform .28s cubic-bezier(.4,0,.2,1);
    z-index:300;
  }
  .sidebar-overlay-mode #sidebar:not(.collapsed) { transform:translateX(0); }

  .sidebar-overlay-mode #main-content { margin-left:0 ; transform:none ; }

  .sidebar-overlay-backdrop {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.38);
    backdrop-filter:saturate(120%) blur(2px);
    z-index:250;
    opacity:0;
    transition:opacity .25s ease;
  }
  .sidebar-overlay-backdrop.is-visible { opacity:1; }

  /* ========= PATCH P0-1：侧栏右缘关闭手势（基于独立热区层） ========= */
 
  /* 关闭手势专用热区 */
  #sidebar-gesture-close-zone {
    position: absolute;
    top: 0;
    right: 0px;
    width: var(--gesture-close-zone-width);             /* User requested default width 24px (was previously discussed as 48px) for narrower edge gesture */
    height: 100%;
    z-index: 350;
    touch-action: none;        /* 我们接管 pointer 以避免系统横向手势抢占 */
    cursor: ew-resize;         /* 调试期可见；最终可改为 default */
    background: linear-gradient(to left, rgba(80, 80, 80, 0.4), rgba(80, 80, 80, 0.0));   /* 调试期可临时改成 rgba(255,0,0,.08) */
    /* 可选：在视觉上需要提示时再加渐变或图标 */
  }

  
    /* === 替换：侧栏浮动按钮极简图标 === */
  #sidebar-toggle {
    all: unset;
    position: fixed;
    top: 10px;
    left: 10px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 6px var(--shadow-color);
    z-index: 1100; 
    transition: background .25s, border-color .25s, box-shadow .25s, transform .2s;
  }

  #sidebar-toggle .icon-sidebar {
    position: relative;
    width: 20px;
    height: 20px;
    display: block;
    box-sizing: border-box;
    border: 2px solid currentColor;
    border-radius: 4px;
    /* 左窄栏着色（可选：用背景提高辨识度） */
    background:
      linear-gradient(to right, rgba(128, 128, 128, 0.5) 0 30%, transparent 0% 100%);
  }

  #sidebar-toggle .icon-sidebar::before {
    /* 竖直分割线（与背景左填充二选一；这里再加细线更清晰） */
    content: "";
    position: absolute;
    top: 0px;
    bottom: 0px;
    left: 30%;
    width: 0;
    border-left: 2px solid currentColor;
  }

  /* 去掉旧的展开/收起图标切换逻辑（若仍存在可保留为空） */
  #sidebar-toggle .icon-collapse,
  #sidebar-toggle .icon-expand {
    display: none !important;
  }

  /* 移除聚焦蓝色高亮：提供一个更柔和或无环样式 */
  #sidebar-toggle:focus {
    outline: none;
    box-shadow: 0 2px 6px var(--shadow-color); /* 或直接 none */
  }

  /* 如果希望压下态不再缩放可移除 scale，保留的话如下： */
  #sidebar-toggle:active {
    transform: scale(.95);
  }

  /* 默认放大按钮时现有背景保留即可 */

  /* === 数据来源说明按钮透明度控制 === */
  .info-source-btn {
    width: 24px;
    height: 24px;
    opacity: .55;
    transition: opacity .25s ease, transform .25s ease;
  }
  .info-source-btn:hover,
  .info-source-btn:focus {
    opacity: 1;
    transform: translateY(-2px);
  }
  .info-source-btn:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(0,0,0,.12);
  }

  /* 若暗色下需要更明显，可选补充：
  [data-theme="dark"] .info-source-btn {
    opacity: .65;
  }
  */

  /* （可选）侧栏展开/收起时不再用 is-collapsed 样式；若你前面添加了
     #sidebar-toggle.is-collapsed .icon-expand 等规则，可删 */
  
  /* 暗色模式微调 */
  [data-theme="dark"] #sidebar-toggle {
    background: var(--bg-secondary);
    border-color: var(--border-color);
  }

  /* 让侧栏上半区两个页签的左右内边距对称，避免整体向右偏移 */
  #top-panel .sidebar-panel-content > nav.tab-nav {
    /* 原来是 padding-left: var(--content-left-gutter); padding-right: var(--content-right-gutter);
       由于这两个值不相等（25px vs 10px），看起来会偏右。这里改为对称。 */
    padding-top: 0 !important;
    padding-left: var(--content-left-gutter) !important;
    padding-right: var(--content-left-gutter) !important;
    margin: 0 ;
  }

  /* 用伪元素画一条“与内容区对齐”的底线，宽度受左右留白限制 */
  #top-panel .sidebar-panel-content > nav.tab-nav::after {
    content: "";
    position: absolute;
    left: var(--content-left-gutter);
    right: var(--content-left-gutter);
    bottom: 0;
    height: 2px;
    background: var(--border-color);
    pointer-events: none;
  }

  /* 右侧子段容器不拉伸 */
  .right-subseg { flex: 0 0 auto; }

  /* segmented 本体不收缩，允许双轴手势（仅控件内部接管手势） */
  .right-subseg .seg {
    flex: 0 0 auto;
    width: auto;
    white-space: nowrap;
    touch-action: pan-x pan-y; /* 双轴都允许，具体拦截在 JS 中判断方向 */
  }

  /* 每个按钮固定宽度，文本居中，不随父容器变化 */
  .right-subseg .seg .seg-btn {
    flex: 0 0 var(--seg-btn-w);
    min-width: var(--seg-btn-w);
    text-align: center;
  }

  /* 拖拽分隔条时，禁用底部面板的过渡，避免视觉抖动 */
  body.is-vert-dragging #bottom-panel {
    transition: none !important;
  }

  /* 移动端（≤600px）右侧导航换行：上行主 Tab，下行子 segmented */
  @media (max-width: 600px) {
    /* 行为：允许换行并收紧间距 */
    .tab-nav.with-subseg {
      flex-wrap: wrap;
      row-gap: 8px;
      column-gap: 10px;
      align-items: flex-start;
    }
    /* 去掉占位的弹性空白列 */
    .tab-nav.with-subseg .flex-1 {
      display: none;
    }
    /* 主页签：并排两列，点击热区更紧凑一些 */
    .tab-nav.with-subseg .tab-nav-item {
      flex: 1 1 calc(50% - 10px);
      text-align: center;
      padding: .55rem .8rem;
      font-size: 15px;
    }
    /* 子页签：整行占满，下沉到第二行并居中 */
    .tab-nav.with-subseg .right-subseg {
      order: 3;
      flex: 1 1 100%;
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 2px;
    }
    .right-panel-card > nav.tab-nav.with-subseg { margin-bottom: 4px; }
    .right-panel-card .rank-content-box { padding-top: 0; }
  }

/* 最近点赞头部：标题单行，右侧 meta 固定在第一行右侧 */
  #recentLikesList .group-header {
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #recentLikesList .group-header .title-wrap {
    position: relative; /* 伪元素定位上下文 */
    flex: 1 1 auto;
    min-width: 0;
  }
  /* 标题文本永远在最上层，不被遮罩覆盖 */
  #recentLikesList .group-header .title-wrap .truncate {
    position: relative;
    z-index: 3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  /* 实色遮罩：与背景同色，宽度=标题可见宽度（JS 注入 --title-w） */
  #recentLikesList .group-header .title-wrap::before {
    content: "";
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    width: var(--title-w, 0px);     /* 只遮到标题末尾 */
    background: var(--bg-secondary);
    pointer-events: none;
    z-index: 1;                     /* 在文本下、meta 上 */
  }
  /* 渐隐遮罩：紧贴标题右缘，向右“背景→透明”过渡，宽度很窄 */
  #recentLikesList .group-header .title-wrap::after {
    content: "";
    position: absolute;
    top: 0;
    bottom: 0;
    left: var(--title-w, 0px);
    width: var(--fade-w, 28px);     /* 可调：24~40px */
    background: linear-gradient(to right, var(--bg-secondary) 0%, rgba(0,0,0,0) 100%);
    pointer-events: none;
    z-index: 2;                     /* 在实色遮罩之上、文本之下 */
  }
  /* 右侧转速/尺寸：固定在第一行右侧，位于遮罩下层 */
  #recentLikesList .group-header .meta-right {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;                      /* 垂直居中 */
    display: flex;
    align-items: center;
    white-space: nowrap;
    text-align: right;
    pointer-events: none;
    overflow: hidden;
    text-overflow: clip;
    z-index: 0;
  }

  /* 场景行单行 + 跑马灯（保留你现有逻辑） */
  #recentLikesList .scenario-row .scenario-text {
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #recentLikesList .recent-marquee-inner {
    display: inline-block;
    will-change: transform;
    transition: transform .35s ease;
  }

  /* === Global Tooltip (主题化) === */
  :root {
    --tooltip-bg: #ffffff;           /* 深色背景（浅色主题下也更清晰） */
    --tooltip-text: #1f2937;
    --tooltip-border: rgba(0,0,0,.18);
    --tooltip-shadow: 0 8px 24px rgba(0,0,0,.18);
  }
  [data-theme="dark"] {
    --tooltip-bg: #1f2937;           /* 暗色主题下更浅一点的深灰 */
    --tooltip-text: #f3f4f6;
    --tooltip-border: rgba(255,255,255,.14);
    --tooltip-shadow: 0 8px 28px rgba(0,0,0,.45);
  }

  /* 全局 tooltip 容器：挂在 body 下，避免被 overflow 裁切 */
  #appTooltip {
    position: fixed;
    z-index: 3000;                   /* 高于 toast(2000) */
    max-width: min(70vw, 320px);
    padding: 8px 10px;
    font-size: 12px;
    line-height: 1.35;
    color: var(--tooltip-text);
    background: var(--tooltip-bg);
    border: 1px solid var(--tooltip-border);
    border-radius: 8px;
    box-shadow: var(--tooltip-shadow);
    pointer-events: none;            /* 不截获鼠标，交给锚点 */
    opacity: 0;
    transform: translate(-50%, -6px);
    transition: opacity .15s ease, transform .15s ease;
    white-space: normal;
  }
  #appTooltip[data-show="1"] {
    opacity: 1;
    transform: translate(-50%, 0);
  }

  /* 小三角（可选） */
  #appTooltip::after {
    content: "";
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: -6px;                    /* 默认朝下方外延（当放在上方展示时，三角在下边） */
    border-width: 6px 6px 0 6px;
    border-style: solid;
    border-color: var(--tooltip-bg) transparent transparent transparent;
  }
  #appTooltip[data-placement="bottom"]::after {
    top: -6px; bottom: auto;
    border-width: 0 6px 6px 6px;
    border-color: transparent transparent var(--tooltip-bg) transparent;
  }

  .share-fail-url {
    word-break: break-all;
    white-space: normal;
    font-family: monospace;
  }
</style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="toastContainer"></div>

  <!-- 左上角浮动侧栏按钮 -->
  <button id="sidebar-toggle" class="sidebar-fab-toggle" aria-label="展开侧栏" title="展开/收起侧栏">
  <span class="icon-sidebar" aria-hidden="true"></span>
  </button>

  <!-- Sidebar -->
  <aside id="sidebar" class="collapsed">
    <div id="sidebar-resizer"></div>
    <div id="sidebar-header">
      <h1 class="text-xl font-bold text-center">数据管理</h1>
    </div>

    <!-- 上半区 -->
    <div id="top-panel" class="sidebar-panel">
      <div class="sidebar-panel-content">
        <nav class="tab-nav" data-tab-group="sidebar-top">
          <div class="tab-nav-item active" data-tab="recent-removed">最近移除</div>
          <div class="tab-nav-item" data-tab="recent-liked">最近点赞</div>
        </nav>

        <div class="tab-content-container" id="sidebar-top-container">
          <div class="tab-content-wrapper" id="sidebar-top-wrapper" aria-live="polite">
            <!-- 最近移除 -->
            <div class="tab-pane" id="recent-removed-pane">
              <div id="recentlyRemovedList" class="space-y-2">
                {% if session.recently_removed_fans and session.recently_removed_fans|length > 0 %}
                  {% set recently_removed_list = session.recently_removed_fans.items()|list %}
                  {% set recently_removed_sorted = recently_removed_list|sort(attribute='1.removed_time', reverse=true) %}
                  {% for key, fan_data in recently_removed_sorted %}
                  <div class="fan-item flex items-center justify-between p-3 border border-gray-200 rounded-md" data-fan-key="{{ key }}">
                    <div class="truncate">
                      <span class="font-medium">{{ fan_data.info.brand }} {{ fan_data.info.model }}</span> - 
                      <span class="text-gray-600 text-sm">
                        {% if fan_data.info.res_loc %}
                          {{ fan_data.info.res_type }}({{ fan_data.info.res_loc }})
                        {% else %}
                          {{ fan_data.info.res_type }}
                        {% endif %}
                      </span>
                    </div>
                    <button class="restore-icon text-lg js-restore-fan tooltip-btn" data-fan-key="{{ key }}" title="恢复至图表">
                      <i class="fa-solid fa-rotate-left"></i>
                    </button>
                  </div>
                  {% endfor %}
                {% else %}
                  <p class="text-gray-500 text-center py-6 empty-removed">暂无最近移除的风扇</p>
                {% endif %}
              </div>
            </div>
            <!-- 最近点赞 -->
            <div class="tab-pane" id="recent-liked-pane">
              <div id="recentLikesList" class="space-y-2">
                <p class="text-gray-500 text-center py-6">首次打开该页签时加载...</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div id="sidebar-splitter">
      <!-- 轨道：把手两侧的“条状实体”，中间留空 -->
      <svg class="splitter-rails" width="100%" height="12px" viewBox="0 0 100 12" preserveAspectRatio="none" aria-hidden="true">
        <!-- 上：左段 / 右段 -->
        <line id="sr-top-left"    x1="0" y1="0.5" x2="0" y2="0.5" stroke="var(--border-color)" stroke-width="1" vector-effect="non-scaling-stroke"></line>
        <line id="sr-top-right"   x1="0" y1="0.5" x2="0" y2="0.5" stroke="var(--border-color)" stroke-width="1" vector-effect="non-scaling-stroke"></line>
        <!-- 下：左段 / 右段 -->
        <line id="sr-bot-left"    x1="0" y1="11.5" x2="0" y2="11.5" stroke="var(--border-color)" stroke-width="1" vector-effect="non-scaling-stroke"></line>
        <line id="sr-bot-right"   x1="0" y1="11.5" x2="0" y2="11.5" stroke="var(--border-color)" stroke-width="1" vector-effect="non-scaling-stroke"></line>
      </svg>
    
      <button id="sidebar-splitter-handle"
              class="splitter-handle"
              type="button"
              role="separator"
              aria-orientation="horizontal"
              aria-label="拖拽调整上下面板高度"></button>
    </div>

    <!-- 下半区 -->
    <div id="bottom-panel" class="sidebar-panel">
      <div class="sidebar-panel-content">
        <h2 class="text-lg font-semibold mb-3">已添加的数据 (<span id="selectedCount">{{ selected_fans|length }}</span>/{{ max_chart_items }})</h2>
        <div id="selectedFansList" class="space-y-2">
          {% for fan in selected_fans %}
          <div class="fan-item flex items-center justify-between p-3 border border-gray-200 rounded-md"
               data-fan-key="{{ fan.key }}"
               data-map="{{ fan.brand }}||{{ fan.model }}||{{ fan.res_type }}||{{ fan.res_loc or '无' }}">
            <div class="flex items-center min-w-0">
              <div class="w-3 h-3 rounded-full mr-2 flex-shrink-0 js-color-dot"></div>
              <div class="truncate">
                <span class="font-medium">{{ fan.brand }} {{ fan.model }}</span> - 
                <span class="text-gray-600 text-sm">
                  {% if fan.res_loc %}
                    {{ fan.res_type }}({{ fan.res_loc }})
                  {% else %}
                    {{ fan.res_type }}
                  {% endif %}
                </span>
              </div>
            </div>
            <div class="flex items-center flex-shrink-0">
              <button class="like-button mr-3"
                      data-fan-key="{{ fan.key }}"
                      data-model-id="{{ fan.model_id }}"
                      data-condition-id="{{ fan.condition_id }}">
                <i class="fa-solid fa-thumbs-up text-gray-400"></i>
              </button>
              <button class="remove-icon text-lg js-remove-fan" data-fan-key="{{ fan.key }}" title="移除">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="sticky-footer text-center {% if not selected_fans %}hidden{% endif %}" id="clearAllContainer">
        <button id="clearAllBtn" class="w-full ui-btn secondary" style="font-size: 16px;">
          移除所有
        </button>
      </div>
    </div>
  </aside>

  <!-- 主内容 -->
  <main id="main-content">
    <div class="container mx-auto px-4 py-8">
      <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-blue-600 mb-2">风扇库</h1>
        <p class="text-gray-600">一个风扇性能可视化对比网站，选择参数并添加到图表</p>
      </header>

      <div style="position: fixed; top: 20px; right: 100px; z-index: 1000;">
        <a href="" class="info-source-btn bg-white text-gray-700 hover:text-blue-600 p-2 rounded-full shadow-md border border-gray-200 flex items-center justify-center" title="数据来源与说明(待开发)">
          <i class="fa-solid fa-circle-info text-lg"></i>
        </a>
      </div>
      <div class="theme-toggle" id="themeToggle" title="切换深浅色">
        <i class="fa-solid fa-moon" id="themeIcon"></i>
      </div>

      <div class="flex flex-col lg:flex-row gap-6 mb-8">
        <!-- 左侧添加 / 搜索区域 -->
        <div class="bg-white rounded-xl shadow-md p-6 lg:w-1/3">
          <nav class="tab-nav" data-tab-group="left-panel">
            <div class="tab-nav-item active" data-tab="add-by-model">按型号添加</div>
            <div class="tab-nav-item" data-tab="filter-by-scenario">按负载场景筛选</div>
          </nav>
            <div class="tab-content-container" id="left-panel-container">
              <div class="tab-content-wrapper" id="left-panel-wrapper">
                <!-- 按型号添加 -->
                <div class="tab-pane" id="add-by-model-pane">
                  <form id="fanForm" class="form-grid">
                    <div class="form-row">
                      <label class="block text-sm font-medium">输入型号直接搜索</label>
                      <div class="relative">
                        <input type="text" id="modelSearchInput" class="ui-field w-full border-gray-300" placeholder="输入型号关键字...">
                        <div id="searchSuggestions" class="absolute z-10 hidden bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto w-full mt-1"></div>
                      </div>
                    </div>

                    <div class="form-row">
                      <label class="block text-sm font-medium">品牌</label>
                      <select id="brandSelect" class="ui-field w-full border-gray-300">
                        <option value="">-- 选择品牌 --</option>
                        {% for brand in brands %}
                          <option value="{{ brand }}">{{ brand }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="form-row">
                      <label class="block text-sm font-medium">型号</label>
                      <select id="modelSelect" class="ui-field w-full border-gray-300" disabled>
                        <option value="">-- 选择型号 --</option>
                      </select>
                      <div id="modelLoading" class="text-sm text-gray-500 mt-1 hidden">加载中...</div>
                    </div>

                    <div class="form-row">
                      <label class="block text-sm font-medium">风阻类型</label>
                      <select id="resTypeSelect" class="ui-field w-full border-gray-300" disabled>
                        <option value="">-- 选择风阻类型 --</option>
                        <option value="全部">全部</option>
                      </select>
                      <div id="resTypeLoading" class="text-sm text-gray-500 mt-1 hidden">加载中...</div>
                    </div>

                    <div class="form-row">
                      <label class="block text-sm font-medium">风阻位置</label>
                      <select id="resLocSelect" class="ui-field w-full border-gray-300" disabled>
                        <option value="">-- 选择风阻位置 --</option>
                        <option value="全部">全部</option>
                      </select>
                      <div id="resLocLoading" class="text-sm text-gray-500 mt-1 hidden">加载中...</div>
                    </div>

                    <div class="form-row">
                      <button type="submit" class="w-full ui-btn success" style="font-size: 16px;">添加至图表</button>
                    </div>
                  </form>
                </div>

                <!-- 按负载场景筛选 -->
                <div class="tab-pane" id="filter-by-scenario-pane">
                  <form id="searchForm" class="form-grid">
                    <div class="form-row">
                      <label class="block text-sm font-medium">风阻类型</label>
                      <select name="search_res_type" class="ui-field w-full border-gray-300">
                        <option value="">-- 选择风阻类型 --</option>
                        {% for type in all_res_types %}
                          <option value="{{ type }}" {% if search_res_type == type %}selected{% endif %}>{{ type }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="form-row">
                      <label class="block text-sm font-medium">风阻位置</label>
                      <select name="search_res_loc" class="ui-field w-full border-gray-300">
                        <option value="">-- 选择风阻位置 --</option>
                        {% for loc in all_res_locs %}
                          <option value="{{ loc }}" {% if search_res_loc == loc %}selected{% endif %}>{{ loc }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="form-row">
                      <label class="block text-sm font-medium">尺寸(mm)</label>
                      <select name="size_filter" class="ui-field w-full border-gray-300">
                        {% for size in size_options %}
                          <option value="{{ size }}" {% if size_filter == size %}selected{% endif %}>{{ size }}{% if size != "不限" %}{% endif %}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="form-row">
                      <label class="block text-sm font-medium">风扇厚度(mm)</label>
                      <div class="flex items-center gap-3">
                        <input type="number" name="thickness_min" value="{{ thickness_min }}" min="1" max="99" class="ui-field w-1/2 border-gray-300" required>
                        <span class="text-gray-600">-</span>
                        <input type="number" name="thickness_max" value="{{ thickness_max }}" min="1" max="99" class="ui-field w-1/2 border-gray-300" required>
                      </div>
                    </div>

                    <div class="form-row">
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="block text-sm font-medium flex items-center">
                            限制条件
                            <button
                              type="button"
                              class="ml-1 cursor-help text-gray-400 hover:text-gray-600 focus:outline-none"
                              data-tooltip="限制条件指在设定的转速或噪音限制下取最佳测试成绩。如：限制转速3000RPM，则意为取3000及以下转速最高风量。选择“无(全速)”将在搜索结果中显示风扇全速运行时的风量数据。"
                              aria-label="限制条件说明"
                            >
                              <i class="fa-solid fa-circle-info text-xs"></i>
                            </button>
                          </label>
                          <select name="sort_by" id="sortBySelect" class="ui-field w-full border-gray-300">
                            <option value="none" {% if sort_by == 'none' %}selected{% endif %}>无(全速)</option>
                            <option value="rpm" {% if sort_by == 'rpm' %}selected{% endif %}>转速(RPM)</option>
                            <option value="noise" {% if sort_by == 'noise' %}selected{% endif %}>噪音(dB)</option>
                          </select>
                        </div>
                        <div>
                          <label class="block text-sm font-medium">限制值</label>
                           <input type="number" inputmode="numeric" step="1" min="1" max="9999" name="sort_value" id="sortValueInput" value="{{ sort_value }}" class="ui-field w-full border-gray-300" {% if sort_by == 'none' %}disabled{% endif %}>
                        </div>
                      </div>
                    </div>

                    <div class="form-row">
                      <button type="submit" class="w-full ui-btn" style="font-size: 16px;">搜索风扇</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
        </div>

        <!-- 右侧排行榜 / 搜索结果 -->
        <div class="bg-white rounded-xl shadow-md p-6 lg:w-2/3 right-panel-card relative">
          <div id="query-count-display" 
               style="position: absolute; top: 0px; right: 0; z-index: 10;
                      font-size: 12px; color: #666; background: rgba(255, 255, 255, 0);
                      padding: 2px 8px; ">
            已执行查询<span id="query-count">0</span>次
          </div>
          <nav class="tab-nav with-subseg" data-tab-group="right-panel">
            <div class="tab-nav-item active" data-tab="top-queries">近期热门查询</div>
            <div class="tab-nav-item" data-tab="search-results">搜索结果</div>
            <div class="flex-1"></div>
            <div class="right-subseg" id="rightSubsegContainer"></div>
          </nav>
          <div class="tab-content-container">
            <div class="tab-content-wrapper" id="right-panel-wrapper">

              <!-- 热门查询 -->
              <div class="tab-pane" id="top-queries-pane">
                <div class="mb-3">
                  <div class="seg" data-active="queries-panel" role="tablist" aria-label="榜单切换">
                    <button class="seg-btn is-active" data-target="queries-panel" role="tab" aria-selected="true" aria-controls="queries-panel">查询榜</button>
                    <button class="seg-btn" data-target="likes-panel" role="tab" aria-selected="false" aria-controls="likes-panel">好评榜</button>
                    <span class="seg-thumb"></span>
                  </div>
                </div>

                <div class="rank-content-box">
                  <div class="rank-panel active" id="queries-panel" role="tabpanel" aria-label="查询榜">
                    <div class="rank-table-scroll">
                      <table class="ranking-table">
                        <thead>
                        <tr>
                          <th class="rank-header">排名</th>
                          <th>品牌</th>
                          <th>型号</th>
                          <th>尺寸</th>
                          <th>热门负载场景</th>
                          <th>查询次数</th>
                          <th class="add-header">添加</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for query in top_queries %}
                        <tr class="hover:bg-gray-50">
                          <td class="rank-cell">
                            {% if loop.index == 1 %}
                              <i class="fa-solid fa-medal gold text-2xl"></i>
                            {% elif loop.index == 2 %}
                              <i class="fa-solid fa-medal silver text-2xl"></i>
                            {% elif loop.index == 3 %}
                              <i class="fa-solid fa-medal bronze text-2xl"></i>
                            {% else %}
                              <span class="font-medium">{{ loop.index }}</span>
                            {% endif %}
                          </td>
                          <td>{{ query.brand_name_zh }}</td>
                          <td>{{ query.model_name }} ({{ query.max_speed }} RPM)</td>
                          <td>{{ query.size }}x{{ query.thickness }}</td>
                          <td>
                            {% if query.resistance_location_zh %}
                              {{ query.resistance_type_zh }}({{ query.resistance_location_zh }})
                            {% else %}
                              {{ query.resistance_type_zh }}
                            {% endif %}
                          </td>
                          <td class="text-blue-600 font-medium">{{ query.query_count }}</td>
                          <td>
                            <button class="btn-add js-ranking-add tooltip-btn"
                                    title="添加到图表"
                                    data-add-type="ranking"
                                    data-brand="{{ query.brand_name_zh }}"
                                    data-model="{{ query.model_name }}"
                                    data-res-type="{{ query.resistance_type_zh }}"
                                    data-res-loc="{{ query.resistance_location_zh or '无' }}">
                              <i class="fa-solid fa-plus"></i>
                            </button>
                          </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="rank-panel" id="likes-panel" role="tabpanel" aria-label="好评榜">
                    <div class="rank-table-scroll">
                      <table class="ranking-table" id="ratingRankTable">
                        <thead>
                        <tr>
                          <th class="rank-header">排名</th>
                          <th>品牌</th>
                          <th>型号</th>
                          <th>尺寸</th>
                          <th>热门负载场景</th>
                          <th>好评次数</th>
                          <th class="add-header">添加</th>
                        </tr>
                        </thead>
                        <tbody id="ratingRankTbody">
                          <tr><td colspan="7" class="text-center text-gray-500 py-6">首次点击“好评榜”加载...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 搜索结果 -->
              <div class="tab-pane" id="search-results-pane">
                <div class="mb-3">
                  <div class="seg" data-active="search-airflow-panel" role="tablist" aria-label="排序视图切换">
                    <button class="seg-btn is-active" data-target="search-airflow-panel" role="tab" aria-selected="true" aria-controls="search-airflow-panel">风量优先</button>
                    <button class="seg-btn" data-target="search-likes-panel" role="tab" aria-selected="false" aria-controls="search-likes-panel">好评优先</button>
                    <span class="seg-thumb"></span>
                  </div>
                </div>

                <div class="rank-content-box">
                  <div id="searchConditionLabel" class="condition-label"></div>

                  <div class="rank-panel active" id="search-airflow-panel" role="tabpanel">
                    <div class="rank-table-scroll">
                      <table class="ranking-table">
                        <thead>
                        <tr>
                          <th>品牌</th>
                          <th>型号</th>
                          <th>尺寸</th>
                          <th>负载场景</th>
                          <th>风量(CFM)</th>
                          <th>场景好评数</th>
                          <th class="add-header">添加</th>
                        </tr>
                        </thead>
                        <tbody id="searchAirflowTbody">
                          <tr><td colspan="7" class="text-center text-gray-500 py-8">使用左侧条件进行搜索</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="rank-panel" id="search-likes-panel" role="tabpanel">
                    <div class="rank-table-scroll">
                      <table class="ranking-table">
                        <thead>
                        <tr>
                          <th>品牌</th>
                          <th>型号</th>
                          <th>尺寸</th>
                          <th>负载场景</th>
                          <th>风量(CFM)</th>
                          <th>场景好评数</th>
                          <th class="add-header">添加</th>
                        </tr>
                        </thead>
                        <tbody id="searchLikesTbody">
                          <tr><td colspan="7" class="text-center text-gray-500 py-8">使用左侧条件进行搜索</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- 图表 -->
      <div class="chart-container bg-white rounded-xl shadow-md p-6 relative" id="chart-settings">
        <div id="chartRoot">
          <iframe id="chartFrame" src="/static/echarts-render.html" allow="fullscreen" allowfullscreen style="width:100%;height:100%;border:0;"></iframe>
        </div>
      </div>
    </div>
  </main>

<script>
/* ==== 命名空间根 ==== */
window.__APP = window.__APP || {};

/* ==== P1-4 DOM 缓存与工具 ==== */
(function initDomCache(){
  const cache = Object.create(null);
  function one(sel, scope){
    if (!sel) return null;
    if (!scope && cache[sel]) return cache[sel];
    const el = (scope||document).querySelector(sel);
    if (!scope) cache[sel] = el;
    return el;
  }
  function all(sel, scope){
    return Array.from((scope||document).querySelectorAll(sel));
  }
  function clear(sel){ if(sel) delete cache[sel]; else Object.keys(cache).forEach(k=>delete cache[k]); }
  window.__APP.dom = { one, all, clear };
})();

/* ==== P1-5 帧写入调度器（低频批量写入） ==== */
window.__APP.scheduler = (function(){
  const writeQueue = [];
  let scheduled = false;
  function flush(){
    scheduled = false;
    for (let i=0;i<writeQueue.length;i++){
      try { writeQueue[i](); } catch(e){ console.error('[scheduler write error]', e); }
    }
    writeQueue.length = 0;
  }
  function write(fn){
    writeQueue.push(fn);
    if (!scheduled){
      scheduled = true;
      requestAnimationFrame(flush);
    }
  }
  return { write };
})();

/* ==== P1-7 通用缓存 (内存+TTL) ==== */
window.__APP.cache = (function(){
  const store = new Map();
  const DEFAULT_TTL = 180000; // 3 分钟
  function key(ns, payload){
    return ns + '::' + JSON.stringify(payload||{});
  }
  function get(ns, payload){
    const k = key(ns, payload);
    const rec = store.get(k);
    if (!rec) return null;
    if (Date.now() > rec.expire) { store.delete(k); return null; }
    return rec.value;
  }
  function set(ns, payload, value, ttl=DEFAULT_TTL){
    const k = key(ns, payload);
    store.set(k, { value, expire: Date.now()+ttl });
    return value;
  }
  function clear(ns){
    if (!ns){ store.clear(); return; }
    for (const k of store.keys()){
      if (k.startsWith(ns+'::')) store.delete(k);
    }
  }
  return { get, set, clear };
})();

/* ==== 快捷选择器（缓存版本） ==== */
const $ = (s) => window.__APP.dom.one(s);

/* =========================================================
   全局配置（后端注入）
   ========================================================= */
window.APP_CONFIG = {
  clickCooldownMs: {{ click_cooldown_ms|default(2000) }},
  maxItems: {{ max_chart_items }}
};


// === POLYFILL + SAFE CLOSEST (全局一次) ===
(function() {
  if (typeof Element !== 'undefined') {
    if (!Element.prototype.matches) {
      Element.prototype.matches =
        Element.prototype.msMatchesSelector ||
        Element.prototype.webkitMatchesSelector ||
        function(selector) {
          const list = (this.document || this.ownerDocument).querySelectorAll(selector);
          let i = 0;
            while (list[i] && list[i] !== this) i++;
          return !!list[i];
        };
    }
    if (!Element.prototype.closest) {
      Element.prototype.closest = function(selector) {
        let el = this;
        while (el && el.nodeType === 1) {
          if (el.matches(selector)) return el;
          el = el.parentElement;
        }
        return null;
      };
    }
  }

  // 覆盖/增强你原来的 safeClosest
  window.safeClosest = function safeClosest(start, selector) {
    if (!start) return null;
    let el = start;
    // 提升文本/注释节点
    if (el.nodeType && el.nodeType !== 1) el = el.parentElement;
    if (!el) return null;
    if (el.closest) {
      try { return el.closest(selector); } catch(_) {}
    }
    while (el && el.nodeType === 1) {
      if (el.matches && el.matches(selector)) return el;
      el = el.parentElement;
    }
    return null;
  };
})();

/* =========================================================
   Overlay 初始化（含 Scroll Lock 计数 + Backdrop + 手势热区保障）
   ========================================================= */
(function initSidebarOverlayModeOnce() {
  const vw = window.innerWidth;
  if (vw >= 600) return;
  const root = document.documentElement;
  root.classList.add('sidebar-overlay-mode');
  const sidebar = $('#sidebar');
  if (!sidebar) return;
  if (!sidebar.classList.contains('collapsed')) sidebar.classList.add('collapsed');

  // Scroll lock 引用计数
  let bodyLockCount = 0;
  let prevBodyOverflow = '';

  function lockBodyScroll() {
    if (bodyLockCount === 0) {
      prevBodyOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
    }
    bodyLockCount++;
  }
  function unlockBodyScroll() {
    bodyLockCount = Math.max(0, bodyLockCount - 1);
    if (bodyLockCount === 0) {
      document.body.style.overflow = prevBodyOverflow;
    }
  }

  function addBackdrop() {
    if (document.querySelector('.sidebar-overlay-backdrop')) {
      requestAnimationFrame(()=>document.querySelector('.sidebar-overlay-backdrop')?.classList.add('is-visible'));
      return;
    }
    const bd = document.createElement('div');
    bd.className = 'sidebar-overlay-backdrop';
    bd.addEventListener('click', () => overlayCloseSidebar());
    document.body.appendChild(bd);
    requestAnimationFrame(()=>bd.classList.add('is-visible'));
  }
  function removeBackdrop() {
    const bd = document.querySelector('.sidebar-overlay-backdrop');
    if (!bd) return;
    bd.classList.remove('is-visible');
    setTimeout(()=>bd.remove(), 220);
  }

  window.overlayOpenSidebar = function overlayOpenSidebar() {
      if (!root.classList.contains('sidebar-overlay-mode')) return;
      const s = document.getElementById('sidebar'); if (!s) return;
      s.classList.remove('collapsed');
      addBackdrop();
      lockBodyScroll();
      ensureGestureZone();
      a11yFocusTrap.activate(s);   // <<< 新增：激活焦点陷阱
      refreshToggleUI && refreshToggleUI();
    };

  window.overlayCloseSidebar = function overlayCloseSidebar() {
      if (!root.classList.contains('sidebar-overlay-mode')) return;
      const s = document.getElementById('sidebar'); if (!s) return;
      if (!s.classList.contains('collapsed')) {
        s.classList.add('collapsed');
        removeBackdrop();
        unlockBodyScroll();
        a11yFocusTrap.deactivate(); 
        const mc = document.getElementById('main-content');
        if (mc) mc.style.marginLeft = '';
        refreshToggleUI && refreshToggleUI();
      }
    };

  window.overlayToggleSidebar = function overlayToggleSidebar() {
    const s = $('#sidebar'); if (!s) return;
    if (s.classList.contains('collapsed')) overlayOpenSidebar(); else overlayCloseSidebar();
  };

  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') overlayCloseSidebar();
  });
})();

/* =========================================================
   P0-1：右缘关闭手势热区
   ========================================================= */
(function initOverlayCloseGestureZone() {
  const root = document.documentElement;
  if (!root.classList.contains('sidebar-overlay-mode')) {
    window.addEventListener('resize', tryLateInit, { once: true });
    return;
  }
  setup();
  function tryLateInit() {
    if (window.innerWidth < 600) setup();
  }
  function setup() {
    window.ensureGestureZone = function ensureGestureZone() {
      const sidebar = $('#sidebar');
      if (!sidebar) return;
      if (document.getElementById('sidebar-gesture-close-zone')) return;
      const zone = document.createElement('div');
      zone.id = 'sidebar-gesture-close-zone';
      zone.setAttribute('role','presentation');
      sidebar.appendChild(zone);
      bindZoneEvents(zone, sidebar);
    };
    window.ensureGestureZone();
  }

  // Derive gesture close zone width from CSS variable for centralized configuration
  const zoneWidthVar = getComputedStyle(document.documentElement).getPropertyValue('--gesture-close-zone-width').trim();
  const GESTURE_CLOSE_ZONE_WIDTH = parseInt(zoneWidthVar, 10) || 24;
  const CLOSE_RATIO = 0.30;
  const MIN_DRAG_X = 12;
  const MAX_SLOPE = 0.65;
  const VELOCITY_CLOSE_PX_PER_MS = -0.8; // 负值：向左快速甩
  const MIN_FLING_DISTANCE = 24;         // 位移至少超过 24px 才考虑速度关闭

  function bindZoneEvents(zone, sidebar) {
    let drag = null;
    function backdrop() { return document.querySelector('.sidebar-overlay-backdrop'); }
    function pt(e) {
      if (e.changedTouches && e.changedTouches.length) {
        const t = e.changedTouches[0];
        return { x: t.clientX, y: t.clientY };
      }
      return { x: e.clientX, y: e.clientY };
    }
    zone.addEventListener('pointerdown', (e)=>{
      if (e.pointerType === 'mouse') return;
      if (sidebar.classList.contains('collapsed')) return;
      const p = pt(e);
      drag = {
        startX: p.x,
        startY: p.y,
        lastX: p.x,
        lastY: p.y,
        width: sidebar.getBoundingClientRect().width,
        dragging: false,
        pointerId: e.pointerId,
        trace: [{ x: p.x, t: performance.now() }]
      };
      try { zone.setPointerCapture(e.pointerId); } catch(_){}
    }, { passive:true });

    zone.addEventListener('pointermove', (e)=>{
      if (!drag || drag.pointerId !== e.pointerId) return;
      const p = pt(e);
      drag.lastX = p.x; drag.lastY = p.y;
      const dx = p.x - drag.startX;
      const dy = p.y - drag.startY;
      if (!drag.dragging) {
        if (dx < -MIN_DRAG_X) {
          const slope = Math.abs(dy / dx);
            if (slope <= MAX_SLOPE) {
              drag.dragging = true;
              sidebar.style.transition='none';
            } else {
              cancelDrag();
            }
        }
        return;
      }
      e.preventDefault();
      const limited = Math.max(-drag.width, dx);
      sidebar.style.transform = `translateX(${limited}px)`;
      const bd = backdrop();
      if (bd) {
        const ratio = Math.max(0, Math.min(1, 1 + limited / drag.width));
        const eased = (function easeOutQuad(t){ return 1 - (1 - t)*(1 - t); })(ratio);
        const op = 0.8 * eased;
        bd.style.opacity = op.toFixed(3);

        // 记录位置用于速度计算
        const now = performance.now();
        drag.trace.push({ x: p.x, t: now });
        if (drag.trace.length > 5) drag.trace.shift();
      }
    }, { passive:false });

    function finishDrag() {
      if (!drag) return;
      const dx = drag.lastX - drag.startX;
      const dist = Math.abs(dx);
      let shouldClose = dist > drag.width * CLOSE_RATIO;

      if (!shouldClose) {
        // 动量判定：满足最小位移 + 速度阈值
        if (dist > MIN_FLING_DISTANCE && drag.trace && drag.trace.length >= 2) {
          const a = drag.trace[drag.trace.length - 2];
          const b = drag.trace[drag.trace.length - 1];
          const dt = Math.max(1, b.t - a.t);
          const vx = (b.x - a.x) / dt; // px/ms
          if (vx <= VELOCITY_CLOSE_PX_PER_MS) {
            shouldClose = true;
          }
        }
      }
      sidebar.style.transition='';
      if (shouldClose) {
        overlayCloseSidebar && overlayCloseSidebar();
        requestAnimationFrame(()=> { sidebar.style.transform=''; });
      } else {
        sidebar.style.transform='translateX(0)';
        const bd = document.querySelector('.sidebar-overlay-backdrop'); if (bd) bd.style.opacity='';
        requestAnimationFrame(()=>{
          if (!sidebar.classList.contains('collapsed')) sidebar.style.transform='';
        });
      }
      cancelDrag();
    }
    function cancelDrag(){ drag = null; }

    zone.addEventListener('pointerup', (e)=>{
      if (!drag || drag.pointerId !== e.pointerId) return;
      if (drag.dragging) finishDrag(); else cancelDrag();
    }, { passive:true });
    zone.addEventListener('pointercancel', (e)=>{
      if (!drag || drag.pointerId !== e.pointerId) return;
      if (drag.dragging) finishDrag(); else cancelDrag();
    }, { passive:true });

    const ro = ('ResizeObserver' in window) ? new ResizeObserver(()=>{
      // Width is now handled by CSS variable, no need to set it dynamically
    }) : null;
    if (ro) ro.observe(sidebar);
  }
})();

/* =========================================================
   工具函数 / Toast / Throttle / HTML 转义
   ========================================================= */
const toastContainerId = 'toastContainer';
function ensureToastRoot() {
  let r = document.getElementById(toastContainerId);
  if (!r) { r = document.createElement('div'); r.id = toastContainerId; document.body.appendChild(r); }
  return r;
}
let toastIdCounter = 0;
const activeLoadingKeys = new Set();
function createToast(msg, type='info', opts={}){
  const container = ensureToastRoot();
  const { autoClose = (type === 'loading' ? false : 2600), id = 't_'+(++toastIdCounter) } = opts;
  const iconMap = {
    success:'<i class="icon fa-solid fa-circle-check" style="color:var(--toast-success)"></i>',
    error:'<i class="icon fa-solid fa-circle-xmark" style="color:var(--toast-error)"></i>',
    loading:'<i class="icon fa-solid fa-spinner fa-spin" style="color:var(--toast-loading)"></i>',
    info:'<i class="icon fa-solid fa-circle-info" style="color:#3B82F6"></i>'
  };
  const div = document.createElement('div');
  div.className = 'toast '+type; div.id = id;
  div.innerHTML = `${iconMap[type]||iconMap.info}<div class="msg">${msg}</div><span class="close-btn" data-close="1">&times;</span>`;
  container.appendChild(div);
  if (autoClose) setTimeout(()=>closeToast(id), autoClose);
  return id;
}
function closeToast(id){
  const el = document.getElementById(id);
  if (!el) return;
  el.style.animation = 'toast-out .25s forwards';
  setTimeout(()=>el.remove(), 240);
}
document.addEventListener('click', (e)=>{
  if (e.target.closest && e.target.closest('[data-close]')) {
    const t = e.target.closest('.toast'); if (t) closeToast(t.id);
  }
});
function showLoading(key,text='加载中...'){
  if (activeLoadingKeys.has(key)) return;
  activeLoadingKeys.add(key);
  createToast(text,'loading',{id:'loading_'+key});
}
function hideLoading(key){
  activeLoadingKeys.delete(key);
  closeToast('loading_'+key);
}
const showSuccess = (m)=>createToast(m,'success');
const showError = (m)=>createToast(m,'error');
const showInfo = (m)=>createToast(m,'info', {autoClose:1800});

let lastGlobalAction = 0;
function globalThrottle(){
  const cd = Number(window.APP_CONFIG.clickCooldownMs || 2000);
  const now = Date.now();
  if (now - lastGlobalAction < cd) { showInfo('操作过于频繁，请稍后'); return false; }
  lastGlobalAction = now; return true;
}
const NO_THROTTLE_ACTIONS = new Set(['add','remove','restore','xaxis']);
const needThrottle = (action)=>!NO_THROTTLE_ACTIONS.has(action);

const ESC_MAP = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' };
function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g,c=>ESC_MAP[c]); }
function unescapeHtml(s){
  const map = {'&amp;':'&','&lt;':'<','&gt;':'>','&quot;':'"','&#39;':"'"};
  return String(s??'').replace(/&(amp|lt|gt|quot|#39);/g,m=>map[m]);
}

/* =========================================================
   颜色映射与图表通讯
   ========================================================= */
function applyServerStatePatchColorIndices(share_meta){
  if (!share_meta) return;
  if (share_meta.color_indices && typeof share_meta.color_indices === 'object') {
    try {
      Object.entries(share_meta.color_indices).forEach(([k,v])=>{
        if (Number.isFinite(v)) { colorIndexMap[k] = v|0; }
      });
      saveColorIndexMap(colorIndexMap);
    } catch(_){}
  }
}

function loadColorIndexMap(){
  try { return JSON.parse(localStorage.getItem('colorIndexMap_v1')||'{}'); } catch { return {}; }
}
function saveColorIndexMap(obj){
  try { localStorage.setItem('colorIndexMap_v1', JSON.stringify(obj)); } catch(_){}
}
let colorIndexMap = loadColorIndexMap();
function ensureColorIndexForKey(key, selectedKeys){
  if (!key) return 0;
  if (Object.prototype.hasOwnProperty.call(colorIndexMap,key)) return colorIndexMap[key]|0;
  const used = new Set();
  (selectedKeys||[]).forEach(k=>{
    if (Object.prototype.hasOwnProperty.call(colorIndexMap,k)) used.add(colorIndexMap[k]|0);
  });
  let idx=0; while(used.has(idx)) idx++;
  colorIndexMap[key]=idx; saveColorIndexMap(colorIndexMap);
  return idx;
}
function ensureColorIndicesForSelected(fans){
  const keys = (fans||[]).map(f=>f.key);
  keys.forEach(k=>ensureColorIndexForKey(k, keys));
}
function colorForKey(key){
  const idx = (Object.prototype.hasOwnProperty.call(colorIndexMap,key)?(colorIndexMap[key]|0):0);
  const palette = currentPalette();
  return palette[idx % palette.length];
}

/* 颜色映射 withFrontColors（保留并附带 color_index） */
function withFrontColors(chartData){
  // 兜底：若分享首次加载且未应用轴类型，则这里也同步一次
  if (__isShareLoaded && !__shareAxisApplied && chartData && chartData.x_axis_type) {
    frontXAxisType = (chartData.x_axis_type === 'noise') ? 'noise_db' : chartData.x_axis_type;
    try { localStorage.setItem('x_axis_type', frontXAxisType); } catch(_){}
    __shareAxisApplied = true;
  }
  const series = (chartData.series||[]).map(s=>{
    const idx = colorIndexMap[s.key] ?? ensureColorIndexForKey(s.key);
    return { ...s, color: colorForKey(s.key), color_index: idx };
  });
  return { ...chartData, x_axis_type: frontXAxisType, series };
}

/* ==== 修正：颜色索引回收与去重（稳定版） ==== */

/* 最小未占用 index */
function nextFreeIndex(assigned){
  let i = 0;
  while (assigned.has(i)) i++;
  return i;
}

/* 释放某个已移除 key 的颜色索引 */
function releaseColorIndexForKey(key){
  if (!key) return;
  if (Object.prototype.hasOwnProperty.call(colorIndexMap, key)) {
    delete colorIndexMap[key];
    saveColorIndexMap(colorIndexMap);
  }
}

/* 只在“缺失或冲突”时重分配；唯一者保持不变，避免颜色抖动 */
function assignUniqueIndicesForSelection(fans){
  const keys = (fans || []).map(f => f.key).filter(Boolean);

  // 统计每个 idx 的拥有数，用于识别冲突
  const countByIdx = new Map(); // idx -> count
  keys.forEach(k => {
    if (Object.prototype.hasOwnProperty.call(colorIndexMap, k)) {
      const idx = colorIndexMap[k] | 0;
      countByIdx.set(idx, (countByIdx.get(idx) || 0) + 1);
    }
  });

  // 已最终占用的索引集合（先占住所有“唯一”的旧索引，保证稳定）
  const assigned = new Set();
  keys.forEach(k => {
    if (Object.prototype.hasOwnProperty.call(colorIndexMap, k)) {
      const idx = colorIndexMap[k] | 0;
      if ((countByIdx.get(idx) || 0) === 1) {
        assigned.add(idx); // 保留旧索引
      }
    }
  });

  // 第二轮：仅对“缺失或冲突”的条目分配新索引
  keys.forEach(k => {
    const has = Object.prototype.hasOwnProperty.call(colorIndexMap, k);
    if (has) {
      const idx = colorIndexMap[k] | 0;
      const isUnique = (countByIdx.get(idx) || 0) === 1;
      if (isUnique) {
        // 唯一者无条件保留旧 idx，避免洗牌
        // 确保占位（即使第一轮已占位，这里重复 add 也安全）
        assigned.add(idx);
        return;
      }
    }
    // 缺失或冲突：分配新 index
    const newIdx = nextFreeIndex(assigned);
    colorIndexMap[k] = newIdx;
    assigned.add(newIdx);
  });

  saveColorIndexMap(colorIndexMap);
}

const chartFrame = $('#chartFrame');
let lastChartData = null;
let likedKeysSet = new Set();
let frontXAxisType = 'rpm';

const chartMessageQueue = [];
let chartFrameReady = false;

function flushChartQueue(){
  if (!chartFrameReady || !chartFrame || !chartFrame.contentWindow) return;
  while(chartMessageQueue.length){
    const msg = chartMessageQueue.shift();
    try {
      chartFrame.contentWindow.postMessage(msg, window.location.origin);
    } catch(e){
      console.warn('postMessage flush error:', e);
      break;
    }
  }
  // 补一次 resize，防止初始化阶段尺寸还未稳定
  setTimeout(()=>resizeChart(), 50);
}

if (chartFrame) {
  chartFrame.addEventListener('load', () => {
    // 若 iframe 未主动发 chart:ready，也在 load 时标记就绪并 flush
    if (!chartFrameReady) {
      chartFrameReady = true;
      flushChartQueue();
      if (lastChartData && !chartMessageQueue.length) {
        postChartData(lastChartData);
      }
    }
  });
}

(function initPersistedXAxisType(){
  try {
    const saved = localStorage.getItem('x_axis_type');
    if (saved === 'rpm' || saved === 'noise_db' || saved === 'noise') {
      frontXAxisType = (saved === 'noise') ? 'noise_db' : saved;
    }
  } catch(_) {}
})();

// 新增：读取图表容器的实际背景色（透明则回退到 body 或白色）
function getChartBg(){
  const host = document.getElementById('chart-settings') || document.body;
  let bg = '';
  try { bg = getComputedStyle(host).backgroundColor; } catch(_) {}
  if (!bg || bg === 'rgba(0, 0, 0, 0)' || bg === 'transparent') {
    try { bg = getComputedStyle(document.body).backgroundColor; } catch(_) {}
  }
  return bg && bg !== 'rgba(0, 0, 0, 0)' ? bg : '#ffffff';
}

const DARK_BASE_PALETTE = [
  "#3E9BFF", // 鲜蓝
  "#FFF958", // 金
  "#42E049", // 绿
  "#FF4848", // 红
  "#DB68FF", // 紫
  "#2CD1E8", // 青
  "#F59916", // 橙
  "#FF67A6", // 粉
  "#8b5cf6", // 次蓝紫
  "#14E39E"  // 次绿
];

/**
 * 检测当前主题
 */
const currentThemeStr = () =>
  (document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light');

const LIGHT_LINEAR_SCALE = 0.66; // 在“物理线性空间”缩放
function srgbToLinear(c){ // 0..1
  return c <= 0.04045 ? c/12.92 : Math.pow((c+0.055)/1.055, 2.4);
}
function linearToSrgb(c){
  return c <= 0.0031308 ? 12.92*c : 1.055*Math.pow(c,1/2.4)-0.055;
}
function darkToLightLinear(hex){
  const h = hex.replace('#','');
  let r = parseInt(h.slice(0,2),16)/255;
  let g = parseInt(h.slice(2,4),16)/255;
  let b = parseInt(h.slice(4,6),16)/255;
  // 解码到线性光
  r = srgbToLinear(r);
  g = srgbToLinear(g);
  b = srgbToLinear(b);
  // 线性缩放
  r *= LIGHT_LINEAR_SCALE;
  g *= LIGHT_LINEAR_SCALE;
  b *= LIGHT_LINEAR_SCALE;
  // 编码回 sRGB
  r = Math.round(linearToSrgb(r)*255);
  g = Math.round(linearToSrgb(g)*255);
  b = Math.round(linearToSrgb(b)*255);
  const to = v=>v.toString(16).padStart(2,'0');
  return '#'+to(r)+to(g)+to(b);
}
function currentPalette(){
  return currentThemeStr()==='dark'
    ? DARK_BASE_PALETTE
    : DARK_BASE_PALETTE.map(darkToLightLinear);
}

window.applySidebarColors = function() {
  const rows = window.__APP.dom.all('#selectedFansList .fan-item');
  window.__APP.scheduler.write(()=> {
    rows.forEach(div => {
      const key = div.getAttribute('data-fan-key');
      const dot = div.querySelector('.js-color-dot');
      if (key && dot) dot.style.backgroundColor = colorForKey(key);
    });
  });
};

function isValidNum(v) {
  return typeof v === 'number' && Number.isFinite(v);
}

function filterChartDataForAxis(chartData) {
  const axis = chartData.x_axis_type === 'noise' ? 'noise_db' : chartData.x_axis_type;
  const cleaned = { ...chartData, series: [] };

  chartData.series.forEach((s) => {
    const rpmArr   = Array.isArray(s.rpm) ? s.rpm : [];
    const noiseArr = Array.isArray(s.noise_db) ? s.noise_db : [];
    const flowArr  = Array.isArray(s.airflow) ? s.airflow : [];

    const xArr = axis === 'noise_db' ? noiseArr : rpmArr;

    const rpmNew = [];
    const noiseNew = [];
    const flowNew = [];

    for (let i = 0; i < xArr.length; i++) {
      const x = xArr[i];
      const y = flowArr[i];
      // 仅当 x 与 airflow 都是“真实数值”时才保留该点
      if (isValidNum(x) && isValidNum(y)) {
        rpmNew.push(isValidNum(rpmArr[i]) ? rpmArr[i] : null);
        noiseNew.push(isValidNum(noiseArr[i]) ? noiseArr[i] : null);
        flowNew.push(y);
      }
    }

    // 当前轴维度下没有任何有效点 -> 整个系列不发送
    const hasAxisPoints = axis === 'noise_db'
      ? noiseNew.some(isValidNum)
      : rpmNew.some(isValidNum);

    if (flowNew.length > 0 && hasAxisPoints) {
      cleaned.series.push({
        ...s,
        rpm: rpmNew,
        noise_db: noiseNew,
        airflow: flowNew
      });
    }
  });

  return cleaned;
}

function postChartData(chartData){
  lastChartData = chartData;
  if (!chartFrame || !chartFrame.contentWindow) return;
  const prepared = withFrontColors(chartData);
  const filtered = filterChartDataForAxis(prepared);
  const payload = {
    chartData: filtered,
    theme: currentThemeStr(),
    chartBg: getChartBg()
  };
  if (pendingShareMeta) {
    payload.shareMeta = pendingShareMeta;
    pendingShareMeta = null;
  }
  const msg = { type:'chart:update', payload };
  if (!chartFrameReady){
    chartMessageQueue.push(msg);
  } else {
    chartFrame.contentWindow.postMessage(msg, window.location.origin);
  }
}

function resizeChart(){
  if (!chartFrame || !chartFrame.contentWindow) return;
  chartFrame.contentWindow.postMessage({ type:'chart:resize' }, window.location.origin);
}

/* =========================================================
   子段 UI（右侧子段定位）
   ========================================================= */
const rightSubsegContainer = $('#rightSubsegContainer');
const segQueriesOrig = document.querySelector('#top-queries-pane .seg');
const segSearchOrig  = document.querySelector('#search-results-pane .seg');
if (segQueriesOrig && rightSubsegContainer){ segQueriesOrig.dataset.paneId='top-queries-pane'; rightSubsegContainer.appendChild(segQueriesOrig); }
if (segSearchOrig && rightSubsegContainer){ segSearchOrig.dataset.paneId='search-results-pane'; rightSubsegContainer.appendChild(segSearchOrig); }
function updateRightSubseg(activeTab){
  if (segQueriesOrig) segQueriesOrig.style.display = (activeTab==='top-queries')?'inline-flex':'none';
  if (segSearchOrig)  segSearchOrig.style.display  = (activeTab==='search-results')?'inline-flex':'none';
}

/* =========================================================
   最近点赞懒加载
   ========================================================= */
let recentLikesLoaded = false;
const recentLikesListEl = $('#recentLikesList');
function rebuildRecentLikes(list){
  const wrap = recentLikesListEl;
  if (!wrap) return;
  wrap.innerHTML = '';
  if (!list || list.length===0){
    wrap.innerHTML = '<p class="text-gray-500 text-center py-6">暂无最近点赞</p>';
    requestAnimationFrame(prepareRecentLikesMarquee);
    return;
  }
  const groups = new Map();
  list.forEach(item=>{
    const brand = item.brand_name_zh || item.brand;
    const model = item.model_name || item.model;
    const size = item.size ?? item.model_size ?? '';
    const thickness = item.thickness ?? item.model_thickness ?? '';
    const maxSpeed = item.max_speed ?? item.maxSpeed ?? '';
    const rt = item.resistance_type_zh || item.res_type || item.resistance_type || '';
    const rl = item.resistance_location_zh || item.res_loc || item.resistance_location || ''; // 允许为空
    const mid = item.model_id ?? item.modelId ?? item.mid ?? '';
    const cid = item.condition_id ?? item.conditionId ?? item.cid ?? '';
    if (!brand || !model || !rt) return; // 仅要求类型存在
    const key = `${brand}||${model}||${size}||${thickness}||${maxSpeed}`;
    if (!groups.has(key)) groups.set(key, { brand, model, size, thickness, maxSpeed, scenarios:[] });
    const g = groups.get(key);
    if (!g.scenarios.some(s=>s.rt===rt && s.rl===rl)) g.scenarios.push({ rt, rl, mid, cid });
  });

  groups.forEach(g=>{
    const metaParts = [];
    if (g.maxSpeed) metaParts.push(`${escapeHtml(g.maxSpeed)} RPM`);
    if (g.size && g.thickness) metaParts.push(`${escapeHtml(g.size)}x${escapeHtml(g.thickness)}`);
    const metaRight = metaParts.join(' · ');

    const scenariosHtml = g.scenarios.map(s=>{
      const scenText = s.rl ? `${escapeHtml(s.rt)} ${escapeHtml(s.rl)}` : `${escapeHtml(s.rt)}`;
      return `
        <div class="flex items-center justify-between scenario-row">
          <div class="scenario-text text-sm text-gray-700">${scenText}</div>
          <div class="actions">
            <button class="like-button recent-like-button" title="取消点赞"
                    data-model-id="${escapeHtml(s.mid||'')}"
                    data-condition-id="${escapeHtml(s.cid||'')}">
              <i class="fa-solid fa-thumbs-up text-red-500"></i>
            </button>
            ${buildQuickBtnHTML('likes', g.brand, g.model, s.rt, s.rl)}
          </div>
        </div>`;
    }).join('');

    const groupDiv = document.createElement('div');
    groupDiv.className='recent-like-group p-3 border border-gray-200 rounded-md';
    groupDiv.innerHTML = `
      <div class="group-header">
        <div class="title-wrap flex items-center min-w-0">
          <div class="truncate font-medium">${escapeHtml(g.brand)} ${escapeHtml(g.model)}</div>
        </div>
        <div class="meta-right text-sm text-gray-600">${metaRight}</div>
      </div>
      <div class="group-scenarios mt-2 space-y-1">${scenariosHtml}</div>`;
    wrap.appendChild(groupDiv);
  });

  syncQuickActionButtons();
  requestAnimationFrame(prepareRecentLikesMarquee);
}

function reloadRecentLikes(){
  showLoading('recent-likes','加载最近点赞...');
  fetch('/api/recent_likes')
    .then(r=>r.json())
    .then(d=>{
      if (!d.success){ showError('获取最近点赞失败'); return; }
      rebuildRecentLikes(d.data||[]);
      recentLikesLoaded = true;
    })
    .catch(err=>showError('获取最近点赞异常: '+err.message))
    .finally(()=>hideLoading('recent-likes'));
}
function loadRecentLikesIfNeeded(){
  if (recentLikesLoaded) return;
  reloadRecentLikes();
}

/* =========================================================
   顶部 / 左 / 右三个 Tab 管理（Sidebar 顶部用 Scroll Snap）
   ========================================================= */
function activateTab(group, tabName, animate = false) {
  if (group === 'sidebar-top') {
    const nav = document.querySelector('.tab-nav[data-tab-group="sidebar-top"]');
    if (nav) {
      nav.querySelectorAll('.tab-nav-item').forEach(it => {
        it.classList.toggle('active', it.dataset.tab === tabName);
      });
    }
    localStorage.setItem('activeTab_sidebar-top', tabName);
    if (tabName === 'recent-liked') loadRecentLikesIfNeeded();
    return;
  }

  // 新增：left-panel 使用横向滚动（Scroll Snap）
  if (group === 'left-panel') {
    const nav = document.querySelector('.tab-nav[data-tab-group="left-panel"]');
    const container = document.getElementById('left-panel-container');
    if (!nav || !container) return;

    const items = [...nav.querySelectorAll('.tab-nav-item')];
    let idx = items.findIndex(i => i.dataset.tab === tabName);
    if (idx < 0) {
      idx = 0;
      tabName = items[0]?.dataset.tab || '';
    }
    items.forEach((it, i) => it.classList.toggle('active', i === idx));

    const left = container.clientWidth * idx;
    if (animate) container.scrollTo({ left, behavior: 'smooth' });
    else container.scrollLeft = left;

    localStorage.setItem('activeTab_left-panel', tabName);
    return; // 不再走通用 transform 逻辑
  }

  // 其余（如 right-panel）沿用原 transform 方案
  const nav = document.querySelector(`.tab-nav[data-tab-group="${group}"]`);
  const wrapper = document.getElementById(`${group}-wrapper`);
  if (!nav || !wrapper) return;

  const items = [...nav.querySelectorAll('.tab-nav-item')];

  // 关键：右侧页签初始化时（animate=false）忽略本地存储，固定用第一个页签
  if (group === 'right-panel' && !animate) {
    tabName = items[0]?.dataset.tab || tabName;
  }

  let idx = items.findIndex(i => i.dataset.tab === tabName);
  if (idx < 0) { idx = 0; tabName = items[0]?.dataset.tab || ''; }
  items.forEach((it, i) => it.classList.toggle('active', i === idx));

  const percent = idx * 50;
  if (!animate) wrapper.style.transition = 'none';
  wrapper.style.transform = `translateX(-${percent}%)`;
  if (!animate) setTimeout(() => wrapper.style.transition = '', 50);

  // 不再保存 right-panel 的本地状态，其它分组仍然保存
  if (group !== 'right-panel') {
    localStorage.setItem('activeTab_' + group, tabName);
  }

  if (group === 'right-panel') updateRightSubseg(tabName);
  if (group === 'sidebar-top' && tabName === 'recent-liked') loadRecentLikesIfNeeded();
  if (group === 'sidebar-top') requestAnimationFrame(() => requestAnimationFrame(syncTopTabsViewportHeight));
}

document.addEventListener('click',(e)=>{
  const item = safeClosest(e.target, '.tab-nav .tab-nav-item');
  if (!item) return;
  const nav = item.closest('.tab-nav');
  const group = nav?.dataset?.tabGroup;
  if (!group) return;
  activateTab(group, item.dataset.tab, true);
});
['left-panel','right-panel','sidebar-top'].forEach(group=>{
  const saved = localStorage.getItem('activeTab_'+group);
  activateTab(group, saved || document.querySelector(`.tab-nav[data-tab-group="${group}"] .tab-nav-item`)?.dataset.tab || '', false);
});

/* ===== 顶部可视高度同步 ===== */
function computeTopPaneViewportHeight(){
  const scroller = document.querySelector('#top-panel .sidebar-panel-content');
  const nav = scroller ? scroller.querySelector('nav.tab-nav') : null;
  if (!scroller || !nav) return 0;
  const scrollerStyle = getComputedStyle(scroller);
  const padBottom = parseFloat(scrollerStyle.paddingBottom)||0;
  const navStyle = getComputedStyle(nav);
  const navMB = parseFloat(navStyle.marginBottom)||0;
  const navH = Math.ceil(nav.getBoundingClientRect().height);
  const avail = scroller.clientHeight - navH - navMB - padBottom;
  return Math.max(0, Math.floor(avail));
}
function syncTopTabsViewportHeight(){
  const container = document.querySelector('#top-panel .tab-content-container');
  if (!container) return;
  const h = computeTopPaneViewportHeight();
  container.style.height = (h>0?h:0)+'px';
}
(function initTopTabsViewport(){
  const scroller = document.querySelector('#top-panel .sidebar-panel-content');
  if (scroller && 'ResizeObserver' in window){
    const ro = new ResizeObserver(()=>requestAnimationFrame(syncTopTabsViewportHeight));
    ro.observe(scroller);
  }
  syncTopTabsViewportHeight();
  window.addEventListener('resize', ()=>requestAnimationFrame(syncTopTabsViewportHeight));
  document.addEventListener('mouseup', ()=>requestAnimationFrame(syncTopTabsViewportHeight));
})();

/* =========================================================
   Sidebar 状态相关 & 拖拽（垂直 splitter / 宽度 resizer）
   ========================================================= */
const sidebar        = $('#sidebar');
const sidebarToggle  = document.getElementById('sidebar-toggle');
const mainContent    = $('#main-content');
const resizer        = document.getElementById('sidebar-resizer');
const splitter       = document.getElementById('sidebar-splitter');
const topPanel       = document.getElementById('top-panel');
const bottomPanel    = document.getElementById('bottom-panel');

function refreshToggleUI(){
  const btn = document.getElementById('sidebar-toggle');
  if (!btn) return;
  const collapsed = sidebar.classList.contains('collapsed');
  btn.setAttribute('aria-label', collapsed ? '展开侧栏' : '收起侧栏');
  btn.setAttribute('aria-expanded', String(!collapsed));
}
refreshToggleUI();

let currentSidebarWidth = sidebar?.getBoundingClientRect().width || 0;
let isCollapsed = sidebar?.classList.contains('collapsed') || false;
let userAdjustedVertical = false;      // 高度锁定（用户拖拽过）
let unlockOnNextExpand = false;        // 收起时不立刻解锁，等下一次展开再解锁

// 解锁并恢复自动高度
function unlockVerticalAuto(){
  userAdjustedVertical = false;
  window.__VERT_DRAGGING = false;
  document.body.classList.remove('is-vert-dragging');
  // 清除由拖拽设置的内联高度/弹性
  if (topPanel) {
    topPanel.style.height = '';
    topPanel.style.flex   = '';
  }
  if (bottomPanel) {
    bottomPanel.style.flex   = '';
    bottomPanel.style.height = '';
  }
  // 触发一次自动布局
  scheduleAdjust && scheduleAdjust();
}

// 在“展开完成”时，如果之前记录了需要解锁，则执行解锁
function maybeUnlockOnExpand(){
  if (!unlockOnNextExpand) return;
  unlockOnNextExpand = false;
  unlockVerticalAuto();
}

// 监听侧栏 class 变化：收起时仅设置“下次展开再解锁”；展开时执行解锁
if (sidebar){
  const mo = new MutationObserver(muts=>{
    for (const m of muts){
      if (m.type === 'attributes' && m.attributeName === 'class'){
        refreshToggleUI();
        const nowCollapsed = sidebar.classList.contains('collapsed');
        if (nowCollapsed){
          // 收起：不要立刻改高度，等下次展开再恢复自动高度
          unlockOnNextExpand = true;
        } else {
          // 展开：如果需要，恢复自动高度
          // 放到下一帧，避免与展开过程的样式竞争
          requestAnimationFrame(maybeUnlockOnExpand);
        }
      }
    }
  });
  mo.observe(sidebar, { attributes:true });
}

function updateTogglePosition(){ /* 位置固定，不再随宽度改变 */ }
updateTogglePosition();

function expandSidebarIfCollapsed(){
  if (!sidebar) return;

  // 新增：窄屏 overlay 模式下，改为调用 overlayOpenSidebar，禁止给主容器加 margin-left
  if (document.documentElement.classList.contains('sidebar-overlay-mode')) {
    if (sidebar.classList.contains('collapsed')) {
      overlayOpenSidebar && overlayOpenSidebar();
    }
    return;
  }

  // 仅桌面模式走原逻辑
  if (isCollapsed){
    sidebar.classList.remove('collapsed');
    if (mainContent) mainContent.style.marginLeft = currentSidebarWidth + 'px';
    isCollapsed = false;
    setTimeout(resizeChart, 300);
    requestAnimationFrame(() => {
      syncTopTabsViewportHeight && syncTopTabsViewportHeight();
      maybeUnlockOnExpand();
    });
    refreshToggleUI();
  }
}

sidebarToggle?.addEventListener('click', ()=>{
  markSidebarToggleClicked();
  if (!sidebar || !mainContent) return;
  if (document.documentElement.classList.contains('sidebar-overlay-mode')) {
    overlayToggleSidebar && overlayToggleSidebar();
    return;
  }
  if (isCollapsed){
    expandSidebarIfCollapsed();
  } else {
    currentSidebarWidth = sidebar.getBoundingClientRect().width;
    sidebar.classList.add('collapsed');
    mainContent.style.marginLeft='0';
    isCollapsed = true;
    // 此处不调用解锁，MutationObserver 已经记录 unlockOnNextExpand
  }
  refreshToggleUI();
});

/* 分隔条：中间把手拖拽（Pointer 统一鼠标+触摸） */
(function initSplitterHandle(){
  if (!splitter) return;

  let handle = document.getElementById('sidebar-splitter-handle');
  if (!handle) {
    handle = document.createElement('button');
    handle.id = 'sidebar-splitter-handle';
    handle.className = 'splitter-handle';
    handle.type = 'button';
    handle.setAttribute('role','separator');
    handle.setAttribute('aria-orientation','horizontal');
    handle.setAttribute('aria-label','拖拽调整上下面板高度');
    splitter.appendChild(handle);
  }

  handle.addEventListener('mousedown', e => e.stopPropagation(), { passive:false });
  handle.addEventListener('touchstart', e => e.stopPropagation(), { passive:false });

  let dragging = false;
  let startY = 0;
  let startTopHeight = 0;
  let maxTop = 0;
  const minTop = 0;

  function measureConstraints(){
    const header = document.getElementById('sidebar-header');
    const sidebarRect = sidebar.getBoundingClientRect();
    const headerH = header ? header.getBoundingClientRect().height : 0;
    const trackHeight = sidebarRect.height - headerH - splitter.offsetHeight;

    const bpContent = bottomPanel?.querySelector('.sidebar-panel-content');
    const bpTitle   = bpContent?.querySelector('h2');
    const footer    = document.getElementById('clearAllContainer');
    const csContent = bpContent ? getComputedStyle(bpContent) : null;

    const titleH    = bpTitle ? Math.ceil(bpTitle.getBoundingClientRect().height) : 0;
    const titleMB   = bpTitle ? parseFloat(getComputedStyle(bpTitle).marginBottom)||0 : 0;
    const contentPT = csContent ? parseFloat(csContent.paddingTop)||0 : 0;
    const footerH   = (footer && !footer.classList.contains('hidden')) ? Math.ceil(footer.getBoundingClientRect().height) : 0;
    const chromeMinBottom = Math.ceil(titleH + titleMB + contentPT + footerH);

    const MIN_BOTTOM_BUSINESS = 0;
    const minBottom = Math.max(MIN_BOTTOM_BUSINESS, chromeMinBottom);

    const _maxTop = Math.max(minTop, trackHeight - minBottom);
    return { headerH, maxTop: _maxTop };
  }

  function onPointerDown(e){
    e.preventDefault();
    e.stopPropagation();
    handle.setPointerCapture?.(e.pointerId);

    // 正确：使用同一个词法变量，锁定自动高度
    userAdjustedVertical = true;

    // 拖拽中标志（关闭过渡 + scheduleAdjust 短路）
    window.__VERT_DRAGGING = true;
    document.body.classList.add('is-vert-dragging');

    const { headerH, maxTop: mt } = measureConstraints();
    maxTop = mt;

    const topH = Math.max(minTop, Math.ceil(topPanel.getBoundingClientRect().height));

    dragging = true;
    startY = e.clientY ?? (e.touches && e.touches[0]?.clientY) ?? 0;
    startTopHeight = topH;

    document.body.style.cursor = 'ns-resize';
    document.body.style.userSelect = 'none';

    function onPointerMove(ev){
      if (!dragging) return;
      const clientY = ev.clientY ?? (ev.touches && ev.touches[0]?.clientY) ?? 0;
      let rawTop = startTopHeight + (clientY - startY);
      rawTop = Math.max(minTop, Math.min(rawTop, maxTop));

      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const snappedTop = (Math.round((headerH + rawTop) * dpr) / dpr) - headerH;

      topPanel.style.height = snappedTop.toFixed(2) + 'px';
      topPanel.style.flex   = '0 0 auto';
      bottomPanel.style.flex = '1 1 auto';
      bottomPanel.style.height = '';

      handle.setAttribute('aria-valuenow', String(Math.round(snappedTop)));
    }

    function end(){
      dragging = false;
      window.__VERT_DRAGGING = false;
      document.body.classList.remove('is-vert-dragging');

      document.body.style.cursor = '';
      document.body.style.userSelect = '';

      window.removeEventListener('pointermove', onPointerMove, { capture:false });
      window.removeEventListener('pointerup',   end,           { capture:false });
      window.removeEventListener('pointercancel', end,         { capture:false });

      // 结束后不触发自动调整；处于“锁定”状态，直到收起并在下次展开时恢复自动高度
    }

    window.addEventListener('pointermove', onPointerMove, { passive:false });
    window.addEventListener('pointerup',   end,           { passive:true  });
    window.addEventListener('pointercancel', end,         { passive:true  });
  }

  handle.addEventListener('pointerdown', onPointerDown, { passive:false });
})();


// === 分隔条“图形轨道”长度计算（把手两侧的条状实体） ===
(function initSplitterRails(){
  const splitter = document.getElementById('sidebar-splitter');
  if (!splitter) return;

  const svg    = splitter.querySelector('svg.splitter-rails');
  const topL   = splitter.querySelector('#sr-top-left');
  const topR   = splitter.querySelector('#sr-top-right');
  const botL   = splitter.querySelector('#sr-bot-left');
  const botR   = splitter.querySelector('#sr-bot-right');

  function updateSplitterRails(){
    if (!splitter || !svg || !topL || !topR || !botL || !botR) return;

    const W = Math.max(0, Math.round(splitter.clientWidth));
    const H = Math.max(0, Math.round(splitter.clientHeight)); // 与 CSS 高度一致（例如 10 或 12）

    const handle = document.getElementById('sidebar-splitter-handle');
    const handleW = Math.max(0, Math.round(handle ? handle.offsetWidth : 72));

    // 把手两侧额外留白；想让线条贴到把手边缘就设为 0
    const GAP_PAD = 0;
    const gapPx = Math.min(W, handleW + 2 * GAP_PAD);

    // 可绘制总长（两侧合计）
    const totalRails = Math.max(0, W - gapPx);

    // 无缝分配：左取 floor，右取剩余，保证 left + right == totalRails
    const leftRail  = Math.floor(totalRails / 2);
    const rightRail = totalRails - leftRail;

    const xLeftStart   = 0;
    const xLeftEnd     = xLeftStart + leftRail;
    const xRightEnd    = W;
    const xRightStart  = xRightEnd - rightRail;

    // 贴顶/底 1px 线（stroke-width=1）
    const yTop = 0.5;
    const yBot = (H || 12) - 0.5;

    // 上边两段
    topL.setAttribute('x1', xLeftStart);  topL.setAttribute('y1', yTop);
    topL.setAttribute('x2', xLeftEnd);    topL.setAttribute('y2', yTop);

    topR.setAttribute('x1', xRightStart); topR.setAttribute('y1', yTop);
    topR.setAttribute('x2', xRightEnd);   topR.setAttribute('y2', yTop);

    // 下边两段
    botL.setAttribute('x1', xLeftStart);  botL.setAttribute('y1', yBot);
    botL.setAttribute('x2', xLeftEnd);    botL.setAttribute('y2', yBot);

    botR.setAttribute('x1', xRightStart); botR.setAttribute('y1', yBot);
    botR.setAttribute('x2', xRightEnd);   botR.setAttribute('y2', yBot);
  }

  function rafUpdate(){ requestAnimationFrame(updateSplitterRails); }
  rafUpdate();
  window.addEventListener('resize', rafUpdate);
  window.updateSplitterRails = updateSplitterRails;
})();


/* 宽度拖拽 */
const SIDEBAR_MIN_W = 260;   // 原 320，按需修改
const SIDEBAR_MAX_W = 700;   // 保持不变或按需调大/调小

if (resizer && sidebar && mainContent){
  let dragging=false, startX=0, startW=0, rafId=null;

  function applyWidth(w){
    sidebar.style.width = w + 'px';
    if (!isCollapsed){
      mainContent.style.marginLeft = w + 'px';
      currentSidebarWidth = w;
      updateTogglePosition();
      if (typeof window.updateSplitterRails === 'function') window.updateSplitterRails();
    }
  }

  function dragStart(clientX){
    dragging = true;
    startX   = clientX;
    startW   = sidebar.getBoundingClientRect().width;
    document.body.classList.add('resizing-sidebar');
    document.body.classList.add('sidebar-hdragging');  // 新增：关闭过渡
    document.body.style.userSelect = 'none';
  }
  function dragMove(clientX){
    if (!dragging) return;
    const dx = clientX - startX;
    let newW = startW + dx;
    newW = Math.max(SIDEBAR_MIN_W, Math.min(SIDEBAR_MAX_W, newW));
    if (!rafId){
      rafId = requestAnimationFrame(()=>{
        applyWidth(newW);
        rafId = null;
      });
    }
  }
  function dragEnd(){
    dragging = false;
    document.body.classList.remove('resizing-sidebar');
    document.body.classList.remove('sidebar-hdragging');  // 新增：恢复过渡
    document.body.style.userSelect = '';
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup',   onMouseUp);
    window.removeEventListener('pointermove', onPtrMove);
    window.removeEventListener('pointerup',   onPtrUp);
    window.removeEventListener('pointercancel', onPtrUp);
    setTimeout(resizeChart,120);
    requestAnimationFrame(syncTopTabsViewportHeight);
    scheduleAdjust();
  }

  function onMouseMove(ev){
    if (ev.cancelable) ev.preventDefault();
    dragMove(ev.clientX);
  }
  function onMouseUp(){ dragEnd(); }

  resizer.addEventListener('mousedown', e=>{
    if (isCollapsed) return;
    if (document.documentElement.classList.contains('sidebar-overlay-mode')) return;
    e.preventDefault();
    dragStart(e.clientX);
    document.addEventListener('mousemove', onMouseMove, { passive:false });
    document.addEventListener('mouseup',   onMouseUp,   { passive:true  });
  });

  function onPtrMove(e){
    if (!dragging) return;
    if (e.cancelable) e.preventDefault();
    dragMove(e.clientX);
  }
  function onPtrUp(){ dragEnd(); }

  resizer.addEventListener('pointerdown', e=>{
    if (isCollapsed) return;
    if (document.documentElement.classList.contains('sidebar-overlay-mode')) return;
    if (e.pointerType !== 'touch' && e.pointerType !== 'pen') return;
    e.preventDefault();
    // 不强制捕获，保持事件冒泡，避免某些环境只动几像素就“卡住”
    dragStart(e.clientX);
    window.addEventListener('pointermove', onPtrMove,   { passive:false });
    window.addEventListener('pointerup',   onPtrUp,     { passive:true  });
    window.addEventListener('pointercancel', onPtrUp,   { passive:true  });
  });
}

/* =========================================================
   主题切换
   ========================================================= */
const themeToggle = $('#themeToggle');
const themeIcon = $('#themeIcon');
let currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
function setTheme(t){
  const prev = document.documentElement.getAttribute('data-theme');
  if (prev === t) {
    // 只更新图标（初始脚本运行时由 head 脚本已经设置 data-theme）
    if (themeIcon) themeIcon.className = t==='dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
    return;
  }
  document.documentElement.setAttribute('data-theme', t);
  if (themeIcon) themeIcon.className = t==='dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
  localStorage.setItem('theme', t);
  fetch('/api/theme',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({theme:t})}).catch(()=>{});
}
setTheme(currentTheme);

themeToggle?.addEventListener('click', ()=>{
  currentTheme = currentTheme==='light' ? 'dark':'light';
  setTheme(currentTheme);
  window.__APP.dom.all('#selectedFansList .fan-item').forEach(div=>{
    const key = div.getAttribute('data-fan-key');
    const dot = div.querySelector('.js-color-dot');
    if (key && dot) dot.style.backgroundColor = colorForKey(key);
  });
  if (lastChartData) {
    postChartData(lastChartData);
  } else {
     resizeChart();
  }
  requestAnimationFrame(syncTopTabsViewportHeight);
});

/* =========================================================
   已选 & 快速按钮索引 / 状态
   ========================================================= */
let selectedMapSet = new Set();
let selectedKeySet = new Set();
function rebuildSelectedIndex(){
  selectedMapSet.clear();
  selectedKeySet.clear();
  window.__APP.dom.all('#selectedFansList .fan-item').forEach(div=>{
    const key = div.getAttribute('data-fan-key');
    if (key) selectedKeySet.add(key);
    const map = div.getAttribute('data-map');
    if (map) selectedMapSet.add(map);
  });
}
rebuildSelectedIndex();

function buildQuickBtnHTML(addType, brand, model, resType, resLoc){
  const raw = (resLoc ?? '');
  const normResLoc = (String(raw).trim() === '') ? '无' : raw; // 统一“空”->“无”
  const mapKey = `${escapeHtml(brand)}||${escapeHtml(model)}||${escapeHtml(resType)}||${escapeHtml(normResLoc)}`;
  const isDup = selectedMapSet.has(mapKey);
  const mode = isDup?'remove':'add';
  const title = isDup?'从图表移除':'添加到图表';
  const icon = isDup?'<i class="fa-solid fa-xmark"></i>':'<i class="fa-solid fa-plus"></i>';
  let cls;
  if (isDup) cls='js-list-remove';
  else if (addType==='search') cls='js-search-add';
  else if (addType==='rating') cls='js-rating-add';
  else if (addType==='ranking') cls='js-ranking-add';
  else cls='js-likes-add';
  return `
    <button class="btn-add ${cls} tooltip-btn"
            title="${title}"
            data-mode="${mode}"
            data-add-type="${addType}"
            data-brand="${escapeHtml(brand)}"
            data-model="${escapeHtml(model)}"
            data-res-type="${escapeHtml(resType)}"
            data-res-loc="${escapeHtml(normResLoc)}">
      ${icon}
    </button>`;
}

function toRemoveState(btn){
  btn.dataset.mode='remove';
  btn.classList.remove('js-ranking-add','js-rating-add','js-search-add','js-likes-add');
  btn.classList.add('js-list-remove');
  btn.title='从图表移除';
  btn.innerHTML='<i class="fa-solid fa-xmark"></i>';
}
function toAddState(btn){
  const addType = btn.dataset.addType || (btn.classList.contains('js-rating-add')?'rating'
    : btn.classList.contains('js-ranking-add')?'ranking'
      : btn.classList.contains('js-search-add')?'search':'likes');
  btn.dataset.mode='add';
  btn.classList.remove('js-list-remove','js-ranking-add','js-rating-add','js-search-add','js-likes-add');
  btn.classList.add(addType==='rating'?'js-rating-add'
    : addType==='ranking'?'js-ranking-add'
      : addType==='search'?'js-search-add':'js-likes-add');
  btn.title='添加到图表';
  btn.innerHTML='<i class="fa-solid fa-plus"></i>';
}
function mapKeyFromDataset(d){
  const b = unescapeHtml(d.brand||''), m=unescapeHtml(d.model||''), rt=unescapeHtml(d.resType||''), rl=unescapeHtml(d.resLoc||'');
  return `${b}||${m}||${rt}||${rl}`;
}
function syncQuickActionButtons(){
  window.__APP.dom.all('.btn-add.tooltip-btn').forEach(btn=>{
    if (!btn.dataset.addType){
      if (btn.classList.contains('js-rating-add')) btn.dataset.addType='rating';
      else if (btn.classList.contains('js-ranking-add')) btn.dataset.addType='ranking';
      else if (btn.classList.contains('js-search-add')) btn.dataset.addType='search';
      else if (btn.classList.contains('js-likes-add')) btn.dataset.addType='likes';
    }
    const d = btn.dataset;
    const key = mapKeyFromDataset(d);
    if (selectedMapSet.has(key)) toRemoveState(btn); else toAddState(btn);
  });
}

let lastSelectedSignature = null;
function computeSignatureFromFans(fans){
  try { return JSON.stringify((fans||[]).map(f=>f.key).sort()); }
  catch { return String((fans||[]).length); }
}

/* =========================================================
   Rebuild 选中 / 移除列表
   ========================================================= */
const selectedListEl = $('#selectedFansList');
const removedListEl  = $('#recentlyRemovedList');
const selectedCountEl = $('#selectedCount');
const clearAllContainer = $('#clearAllContainer');
const clearAllBtn = $('#clearAllBtn');

function rebuildSelectedFans(fans){
  selectedListEl.innerHTML='';
  ensureColorIndicesForSelected(fans||[]);
  if (!fans || fans.length===0){
    selectedCountEl.textContent='0';
    clearAllContainer?.classList.add('hidden');
    rebuildSelectedIndex();
    requestAnimationFrame(window.applySidebarColors);
    requestAnimationFrame(prepareSidebarMarquee);
    scheduleAdjust();
    return;
  }
  fans.forEach(f=>{
    const keyStr = `${f.model_id}_${f.condition_id}`;
    const isLiked = likedKeysSet.has(keyStr);
    const div = document.createElement('div');
    div.className='fan-item flex items-center justify-between p-3 border border-gray-200 rounded-md';
    div.dataset.fanKey = f.key;
    const normLoc = (f.res_loc && String(f.res_loc).trim() !== '') ? f.res_loc : '无';
    div.dataset.map = `${f.brand}||${f.model}||${f.res_type}||${normLoc}`;
    div.innerHTML=`
      <div class="flex items-center min-w-0">
        <div class="w-3 h-3 rounded-full mr-2 flex-shrink-0 js-color-dot"></div>
        <div class="truncate">
          <span class="font-medium">${escapeHtml(f.brand)} ${escapeHtml(f.model)}</span> - 
          <span class="text-gray-600 text-sm">${formatScenario(f.res_type, f.res_loc)}</span>
        </div>
      </div>
      <div class="flex items-center flex-shrink-0">
        <button class="like-button mr-3" data-fan-key="${f.key}" data-model-id="${f.model_id}" data-condition-id="${f.condition_id}">
          <i class="fa-solid fa-thumbs-up ${isLiked?'text-red-500':'text-gray-400'}"></i>
        </button>
        <button class="remove-icon text-lg js-remove-fan" data-fan-key="${f.key}" title="移除">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>`;
    selectedListEl.appendChild(div);
    const dot = div.querySelector('.js-color-dot');
    if (dot) dot.style.backgroundColor = colorForKey(f.key);
  });
  selectedCountEl.textContent = fans.length.toString();
  clearAllContainer?.classList.remove('hidden');
  rebuildSelectedIndex();
  requestAnimationFrame(prepareSidebarMarquee);
  scheduleAdjust();
}

function rebuildRemovedFans(list){
  removedListEl.innerHTML='';
  if (!list || list.length===0){
    removedListEl.innerHTML='<p class="text-gray-500 text-center py-6 empty-removed">暂无最近移除的风扇</p>';
    requestAnimationFrame(prepareSidebarMarquee);
    return;
  }
  list.forEach(item=>{
    if (selectedKeySet.has(item.key)) return;
    const div = document.createElement('div');
    div.className='fan-item flex items-center justify-between p-3 border border-gray-200 rounded-md';
    div.dataset.fanKey = item.key;
    div.innerHTML=`
      <div class="truncate">
        <span class="font-medium">${escapeHtml(item.brand)} ${escapeHtml(item.model)}</span> - 
        <span class="text-gray-600 text-sm">${formatScenario(item.res_type, item.res_loc)}</span>
      </div>
      <button class="restore-icon text-lg js-restore-fan" data-fan-key="${item.key}" title="恢复至图表">
        <i class="fa-solid fa-rotate-left"></i>
      </button>`;
    removedListEl.appendChild(div);
  });
  requestAnimationFrame(syncTopTabsViewportHeight);
  requestAnimationFrame(prepareSidebarMarquee);
}

/* =========================================================
   统一状态处理
   ========================================================= */
let pendingShareMeta = null;  
let __isShareLoaded = (function(){
  try {
    const usp = new URLSearchParams(window.location.search);
    return usp.get('share_loaded') === '1';
  } catch(_) { return false; }
})();
let __shareAxisApplied = false;

function processState(data, successMsg){
  const prevSelectedKeys = new Set(selectedKeySet);

  if (data.error_message){ hideLoading('op'); showError(data.error_message); }
  else { if (successMsg) showSuccess(successMsg); hideLoading('op'); }

  let pendingChart = null;
  if ('chart_data' in data) pendingChart = data.chart_data;

  /* 新增：如果 share_meta 在本次返回，优先处理颜色索引映射 */
  if ('share_meta' in data && data.share_meta) {
    applyServerStatePatchColorIndices(data.share_meta);
  }

  if ('like_keys' in data) likedKeysSet = new Set(data.like_keys||[]);

  if ('selected_fans' in data) {
    const incomingKeys = new Set((data.selected_fans || []).map(f => f.key).filter(Boolean));
    try {
      prevSelectedKeys.forEach(k => { if (!incomingKeys.has(k)) releaseColorIndexForKey(k); });
    } catch(_) {}

    /* 不再在这里“重排”颜色，如果分享携带了 color_indices 则已经写入 colorIndexMap。
       若需要确保唯一仍可调用 assignUniqueIndicesForSelection */
    assignUniqueIndicesForSelection(data.selected_fans);
    rebuildSelectedFans(data.selected_fans);
  }

  if ('recently_removed_fans' in data) rebuildRemovedFans(data.recently_removed_fans);

  if ('share_meta' in data && data.share_meta) {
    pendingShareMeta = {
      show_raw_curves: data.share_meta.show_raw_curves,
      show_fit_curves: data.share_meta.show_fit_curves,
      pointer_x_rpm: data.share_meta.pointer_x_rpm,
      pointer_x_noise_db: data.share_meta.pointer_x_noise_db,
      legend_hidden_keys: data.share_meta.legend_hidden_keys
      // color_indices 已提前处理
    };

    if (__isShareLoaded && !__shareAxisApplied && data.chart_data && data.chart_data.x_axis_type) {
      frontXAxisType = (data.chart_data.x_axis_type === 'noise') ? 'noise_db' : data.chart_data.x_axis_type;
      try { localStorage.setItem('x_axis_type', frontXAxisType); } catch(_){}
      __shareAxisApplied = true;
    }
  }

  if (pendingChart) postChartData(pendingChart);

  syncQuickActionButtons();
  wrapMarqueeForExistingTables();
  scheduleAdjust();
}

/* =========================================================
   POST 助手
   ========================================================= */
async function apiPost(url, payload){
  const resp = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload||{})
  });
  if (!resp.ok) throw new Error('HTTP '+resp.status);
  return resp.json();
}

/* =========================================================
   点赞排行（缓存 + TTL + 后台刷新）
   ========================================================= */
let likesTabLoaded = false;
let likesTabLastLoad = 0;
const LIKES_TTL = 120000;
function needReloadLikes(){
  if (!likesTabLoaded) return true;
  return (Date.now() - likesTabLastLoad) > LIKES_TTL;
}
let _rtPending = false, _rtDebounce = null;

function reloadTopRatings(debounce=true){
  if (debounce){
    if (_rtDebounce) clearTimeout(_rtDebounce);
    return new Promise(resolve=>{ _rtDebounce = setTimeout(()=>resolve(reloadTopRatings(false)), 250); });
  }
  if (_rtPending) return Promise.resolve();
  _rtPending = true;

  const cacheNS = 'top_ratings';
  const payload = {};
  const cached = window.__APP.cache.get(cacheNS, payload);
  if (cached && !needReloadLikes()){
    applyRatingTable(cached);
    _rtPending = false;
    return Promise.resolve();
  }

  const tbody = document.getElementById('ratingRankTbody');
  if (tbody && !likesTabLoaded) tbody.innerHTML='<tr><td colspan="7" class="text-center text-gray-500 py-6">加载中...</td></tr>';

  return fetch('/api/top_ratings')
    .then(r=>r.json())
    .then(data=>{
      if (!data.success){ showError('更新点赞排行失败'); return; }
      window.__APP.cache.set(cacheNS, payload, data, LIKES_TTL);
      applyRatingTable(data);
    })
    .catch(err=> showError('获取点赞排行异常: '+err.message))
    .finally(()=>{ _rtPending=false; });
}

function applyRatingTable(data){
  const list = data.data || [];
  const tbody = document.getElementById('ratingRankTbody');
  if (!tbody) return;
  if (list.length===0){
    tbody.innerHTML='<tr><td colspan="7" class="text-center text-gray-500 py-6">暂无点赞排行数据</td></tr>';
    return;
  }
  let html='';
  list.forEach((r, idx)=>{
    const rank = idx+1;
    const medal = rank===1?'gold':rank===2?'silver':rank===3?'bronze':'';
    const rankCell = medal?`<i class="fa-solid fa-medal ${medal} text-2xl"></i>`:`<span class="font-medium">${rank}</span>`;
    const locRaw = r.resistance_location_zh || '';
    const scen = formatScenario(r.resistance_type_zh, locRaw);
    const locForKey = locRaw || '全部';
    const mapKey = `${escapeHtml(r.brand_name_zh)}||${escapeHtml(r.model_name)}||${escapeHtml(r.resistance_type_zh)}||${escapeHtml(locForKey)}`;
    const isDup = selectedMapSet.has(mapKey);
    const btnMode = isDup?'remove':'add';
    const btnClass = isDup?'js-list-remove':'js-rating-add';
    const btnTitle = isDup?'从图表移除':'添加到图表';
    const btnIcon  = isDup?'<i class="fa-solid fa-xmark"></i>':'<i class="fa-solid fa-plus"></i>';
    html+=`
      <tr class="hover:bg-gray-50">
        <td class="rank-cell">${rankCell}</td>
        <td class="nowrap marquee-cell"><span class="marquee-inner">${escapeHtml(r.brand_name_zh)}</span></td>
        <td class="nowrap marquee-cell"><span class="marquee-inner">${escapeHtml(r.model_name)} (${r.max_speed} RPM)</span></td>
        <td class="nowrap marquee-cell"><span class="marquee-inner">${escapeHtml(r.size)}x${escapeHtml(r.thickness)}</span></td>
        <td class="nowrap marquee-cell"><span class="marquee-inner">${scen}</span></td>
        <td class="text-blue-600 font-medium">${escapeHtml(r.like_count)}</td>
        <td>
          <button class="btn-add ${btnClass} tooltip-btn"
                  title="${btnTitle}"
                  data-mode="${btnMode}"
                  data-add-type="rating"
                  data-brand="${escapeHtml(r.brand_name_zh)}"
                  data-model="${escapeHtml(r.model_name)}"
                  data-res-type="${escapeHtml(r.resistance_type_zh)}"
                  data-res-loc="${escapeHtml(locForKey)}">
            ${btnIcon}
          </button>
        </td>
      </tr>`;
  });
  tbody.innerHTML=html;
  likesTabLoaded = true;
  likesTabLastLoad = Date.now();
  syncQuickActionButtons();
  prepareMarqueeCells(tbody, [1,2,3,4]);
}

function loadLikesIfNeeded(){
  if (!needReloadLikes()) return;
  showLoading('rating-refresh','加载好评榜...');
  reloadTopRatings(false).finally(()=>hideLoading('rating-refresh'));
}

/* =========================================================
   搜索（缓存 + 后台刷新）
   ========================================================= */
const searchForm = $('#searchForm');
const searchAirflowTbody = $('#searchAirflowTbody');
const searchLikesTbody = $('#searchLikesTbody');
let SEARCH_RESULTS_RAW = [];

function fillSearchTable(tbody, list){
  if (!tbody) return;
  if (!list.length){
    tbody.innerHTML='<tr><td colspan="7" class="text-center text-gray-500 py-6">没有符合条件的结果</td></tr>';
    return;
  }
  tbody.innerHTML = list.map(r=>{
    const brand = r.brand_name_zh;
    const model = r.model_name;
    const resType = r.resistance_type_zh;
    const resLocRaw = r.resistance_location_zh || '';
    const scenLabel = formatScenario(resType, resLocRaw);
    return `
      <tr class="hover:bg-gray-50">
        <td class="nowrap marquee-cell"><span class="marquee-inner">${escapeHtml(brand)}</span></td>
        <td class="nowrap marquee-cell"><span class="marquee-inner">${escapeHtml(model)} (${r.max_speed} RPM)</span></td>
        <td class="nowrap marquee-cell"><span class="marquee-inner">${escapeHtml(r.size)}x${escapeHtml(r.thickness)}</span></td>
        <td class="nowrap marquee-cell"><span class="marquee-inner">${scenLabel}</span></td>
        <td class="text-blue-600 font-medium text-sm">${Number(r.max_airflow).toFixed(1)}</td>
        <td class="text-blue-600 font-medium">${r.like_count ?? 0}</td>
        <td>${buildQuickBtnHTML('search', brand, model, resType, resLocRaw)}</td>
      </tr>`;
  }).join('');
  prepareMarqueeCells(tbody, [0,1,2,3]);
}

function renderSearchResults(results, conditionLabel){
  SEARCH_RESULTS_RAW = results.slice();
  const byAirflow = SEARCH_RESULTS_RAW;
  const byLikes = SEARCH_RESULTS_RAW.slice().sort((a,b)=>(b.like_count||0)-(a.like_count||0));
  const labelEl = document.getElementById('searchConditionLabel');
  if (labelEl) labelEl.textContent = conditionLabel;
  fillSearchTable(searchAirflowTbody, byAirflow);
  fillSearchTable(searchLikesTbody, byLikes);
  syncQuickActionButtons();
}

if (searchForm){
  searchForm.addEventListener('submit', async e=>{
    e.preventDefault();
    if (!searchForm.reportValidity()) return; // 用原生 min/max/step 校验
    if (needThrottle('search') && !globalThrottle()) return;
    const fd = new FormData(searchForm);
    const payload = {}; fd.forEach((v,k)=>payload[k]=v);
    const cacheNS='search';
    const cached = window.__APP.cache.get(cacheNS, payload);
    if (cached){
      renderSearchResults(cached.search_results, cached.condition_label);
      showInfo('已使用缓存结果，后台刷新中...');
      refreshFromServer();
    } else {
      showLoading('op','搜索中...');
      try {
        const data = await doFetch();
        if (!data.success){
          hideLoading('op'); showError(data.error_message||'搜索失败');
          searchAirflowTbody.innerHTML='<tr><td colspan="7" class="text-center text-gray-500 py-6">搜索失败</td></tr>';
          searchLikesTbody.innerHTML='<tr><td colspan="7" class="text-center text-gray-500 py-6">搜索失败</td></tr>';
          return;
        }
        window.__APP.cache.set(cacheNS, payload, data);
        renderSearchResults(data.search_results, data.condition_label);
        hideLoading('op'); showSuccess('搜索完成');
        document.querySelector('.tab-nav[data-tab-group="right-panel"] .tab-nav-item[data-tab="search-results"]')?.click();
      } catch(err){
        hideLoading('op'); showError('搜索异常: '+err.message);
        searchAirflowTbody.innerHTML='<tr><td colspan="7" class="text-center text-gray-500 py-6">搜索失败</td></tr>';
        searchLikesTbody.innerHTML='<tr><td colspan="7" class="text-center text-gray-500 py-6">搜索失败</td></tr>';
      }
    }

    async function doFetch(){
      return fetch('/api/search_fans',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r=>r.json());
    }
    async function refreshFromServer(){
      try {
        const fresh = await doFetch();
        if (fresh.success){
          window.__APP.cache.set(cacheNS, payload, fresh);
          if (!cached || JSON.stringify(cached.search_results)!==JSON.stringify(fresh.search_results)){
            renderSearchResults(fresh.search_results, fresh.condition_label);
            showInfo('已刷新最新结果');
          }
        }
      } catch(_){}
    }
  });
}

/* =========================================================
   级联选择
   ========================================================= */
const fanForm = $('#fanForm');
const brandSelect = $('#brandSelect');
const modelSelect = $('#modelSelect');
const resTypeSelect = $('#resTypeSelect');
const resLocSelect = $('#resLocSelect');

if (brandSelect){
  brandSelect.addEventListener('change', ()=>{
    const b = (brandSelect.value || '').trim();

    // 根据是否已选品牌切换占位提示与锁定状态
    modelSelect.innerHTML   = `<option value="">${b ? '-- 选择型号 --' : '-- 请先选择品牌 --'}</option>`;
    modelSelect.disabled    = !b;

    resTypeSelect.innerHTML = `<option value="">${b ? '-- 请先选择型号 --' : '-- 请先选择品牌 --'}</option>`;
    resTypeSelect.disabled  = true;

    resLocSelect.innerHTML  = `<option value="">${b ? '-- 请先选择型号 --' : '-- 请先选择品牌 --'}</option>`;
    resLocSelect.disabled   = true;

    if (!b) return;

    fetch(`/get_models/${encodeURIComponent(b)}`).then(r=>r.json()).then(models=>{
      models.forEach(m=>{
        const o=document.createElement('option'); o.value=m; o.textContent=m; modelSelect.appendChild(o);
      });
      modelSelect.disabled=false;
    });
  });
}

if (modelSelect){
  modelSelect.addEventListener('change', ()=>{
    const b=(brandSelect.value||'').trim(), m=(modelSelect.value||'').trim();

    // 型号未选 → 下游显示“请先选择型号”；已选 → 类型可选、位置提示“先选类型”
    resTypeSelect.innerHTML = m
      ? '<option value="">-- 选择风阻类型 --</option><option value="全部">全部</option>'
      : '<option value="">-- 请先选择型号 --</option>';
    resTypeSelect.disabled  = true;

    resLocSelect.innerHTML  = m
      ? '<option value="">-- 请先选择风阻类型 --</option>'
      : '<option value="">-- 请先选择型号 --</option>';
    resLocSelect.disabled   = true;

    if (!b || !m) return;

    fetch(`/get_resistance_types/${encodeURIComponent(b)}/${encodeURIComponent(m)}`).then(r=>r.json()).then(types=>{
      types.forEach(t=>{
        const o=document.createElement('option'); o.value=t; o.textContent=t; resTypeSelect.appendChild(o);
      });
      resTypeSelect.disabled=false;
    });
  });
}

if (resTypeSelect){
  resTypeSelect.addEventListener('change', ()=>{
    const b=(brandSelect.value||'').trim(), m=(modelSelect.value||'').trim(), rt=(resTypeSelect.value||'').trim();

    // 未选风阻类型 → 位置提示“请先选择风阻类型”
    if (!rt){
      resLocSelect.innerHTML = '<option value="">-- 请先选择风阻类型 --</option>';
      resLocSelect.disabled  = true;
      return;
    }

    // 预设默认占位（位置可选 + “全部”）
    resLocSelect.innerHTML = '<option value="">-- 选择风阻位置 --</option><option value="全部">全部</option>';
    resLocSelect.disabled  = true;

    if (!b || !m || !rt) return;

    // 新增：空载 → 位置锁定为“无”，并禁用下拉
    if (rt === '空载'){
      resLocSelect.innerHTML = '<option value="无" selected>无</option>';
      resLocSelect.disabled = true;
      return;
    }

    // 原逻辑：选择“全部” → 允许位置不筛选
    if (rt === '全部'){ 
      resLocSelect.innerHTML = '<option value="全部" selected>全部</option>';
      resLocSelect.disabled=true; 
      return; 
    }

    // 其它类型 → 拉取具体位置选项
    fetch(`/get_resistance_locations/${encodeURIComponent(b)}/${encodeURIComponent(m)}/${encodeURIComponent(rt)}`).then(r=>r.json()).then(locs=>{
      locs.forEach(l=>{
        const o=document.createElement('option'); o.value=l; o.textContent=l; resLocSelect.appendChild(o);
      });
      resLocSelect.disabled=false;
    });
  });
}

// 首次加载时应用占位提示（不选品牌则显示“请先选择品牌”）
if (brandSelect) {
  brandSelect.dispatchEvent(new Event('change'));
}

/* 型号关键字搜索 */
const modelSearchInput = $('#modelSearchInput');
const searchSuggestions = $('#searchSuggestions');
let modelDebounceTimer;
if (modelSearchInput && searchSuggestions){
  modelSearchInput.addEventListener('input', ()=>{
    clearTimeout(modelDebounceTimer);
    const q = modelSearchInput.value.trim();
    if (q.length < 2){ searchSuggestions.classList.add('hidden'); return; }
    modelDebounceTimer = setTimeout(()=>{
      fetch(`/search_models/${encodeURIComponent(q)}`).then(r=>r.json()).then(list=>{
        searchSuggestions.innerHTML='';
        if (list.length===0){ searchSuggestions.classList.add('hidden'); return; }
        list.forEach(full=>{
          const div=document.createElement('div');
            div.className='cursor-pointer'; div.textContent=full;
            div.addEventListener('click', ()=>{
              const parts = full.split(' ');
              const brand=parts[0]; const model=parts.slice(1).join(' ');
              brandSelect.value=brand;
              brandSelect.dispatchEvent(new Event('change'));
              setTimeout(()=>{
                modelSelect.value=model;
                modelSelect.dispatchEvent(new Event('change'));
                modelSearchInput.value='';
                searchSuggestions.classList.add('hidden');
              },300);
            });
            searchSuggestions.appendChild(div);
        });
        searchSuggestions.classList.remove('hidden');
      }).catch(()=>searchSuggestions.classList.add('hidden'));
    },280);
  });
  document.addEventListener('click', e=>{
    if (!modelSearchInput.contains(e.target) && !searchSuggestions.contains(e.target)){
      searchSuggestions.classList.add('hidden');
    }
  });
}

/* =========================================================
   点赞 / 快速按钮操作 / 恢复 / 清空
   ========================================================= */

// === PATCH: 点赞 & 最近点赞 延迟刷新调度 ===
let recentLikesRefreshTimer = null;
const RECENT_LIKES_REFRESH_DELAY = 650;   // 可调：合并多次点赞后再刷新列表
let topRatingsRefreshTimer = null;
const TOP_RATINGS_REFRESH_DELAY = 800;

// 统一调度最近点赞刷新（仅当最近点赞面板曾经加载过再做刷新）
function scheduleRecentLikesRefresh() {
  if (!recentLikesLoaded) return; // 未加载过，不必刷新
  clearTimeout(recentLikesRefreshTimer);
  recentLikesRefreshTimer = setTimeout(() => {
    reloadRecentLikes();
  }, RECENT_LIKES_REFRESH_DELAY);
}

// 同理：好评榜（likesTabLoaded 为 true 后才刷新）
function scheduleTopRatingsRefresh() {
  if (!likesTabLoaded) return;
  clearTimeout(topRatingsRefreshTimer);
  topRatingsRefreshTimer = setTimeout(() => {
    reloadTopRatings(false);
  }, TOP_RATINGS_REFRESH_DELAY);
}

// 批量更新所有出现该 (model_id, condition_id) 的点赞图标
function updateLikeIcons(modelId, conditionId, isLiked) {
  window.__APP.dom.all(`.like-button[data-model-id="${modelId}"][data-condition-id="${conditionId}"]`)
    .forEach(btn => {
      const ic = btn.querySelector('i');
      if (!ic) return;
      ic.classList.toggle('text-red-500', isLiked);
      ic.classList.toggle('text-gray-400', !isLiked);
    });
}


document.addEventListener('click', async e=>{
  /* 点赞 / 取消 */
  const likeBtn = safeClosest(e.target, '.like-button');
  if (likeBtn) {
    if (needThrottle('like') && !globalThrottle()) return;
    const modelId = likeBtn.dataset.modelId;
    const conditionId = likeBtn.dataset.conditionId;
    if (!modelId || !conditionId) { showError('缺少点赞标识'); return; }

    // 当前状态（按钮内 <i>）
    const icon = likeBtn.querySelector('i');
    const prevLiked = icon.classList.contains('text-red-500');
    const nextLiked = !prevLiked;
    const url = prevLiked ? '/api/unlike' : '/api/like';

    // 1) 乐观更新（立刻切换 UI ）
    updateLikeIcons(modelId, conditionId, nextLiked);

    // 2) 维护本地 likedKeysSet（乐观）
    const keyStr = `${modelId}_${conditionId}`;
    if (nextLiked) likedKeysSet.add(keyStr); else likedKeysSet.delete(keyStr);

    // 3) 不再 showLoading（避免频繁 Toast），改为轻量提示（可选）
    // showInfo(nextLiked ? '点赞中...' : '取消点赞中...');

    // 4) 发请求
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model_id: modelId, condition_id: conditionId })
    })
      .then(r => r.json())
      .then(d => {
        if (!d.success) {
          // 回滚 UI
            updateLikeIcons(modelId, conditionId, prevLiked);
            if (prevLiked) likedKeysSet.add(keyStr); else likedKeysSet.delete(keyStr);
            showError(d.error_message || '点赞操作失败');
            return;
        }
        // 以服务端回传为准更新 likedKeysSet（防止并发误差）
        if (Array.isArray(d.like_keys)) {
          likedKeysSet = new Set(d.like_keys);
          // 统一再刷新一次对应图标（确保与服务器最终一致）
          const finalLiked = likedKeysSet.has(keyStr);
          updateLikeIcons(modelId, conditionId, finalLiked);
        }

        // 不再立即 reloadRecentLikes / reloadTopRatings
        // 改为延迟合并刷新（如果对应面板已加载过）
        scheduleRecentLikesRefresh();
        scheduleTopRatingsRefresh();

        showSuccess(prevLiked ? '已取消点赞' : '已点赞');
      })
      .catch(err => {
        // 网络错误回滚
        updateLikeIcons(modelId, conditionId, prevLiked);
        if (prevLiked) likedKeysSet.add(keyStr); else likedKeysSet.delete(keyStr);
        showError('网络错误：' + err.message);
      });

    return;
  }

  /* 快速删除（按钮状态是 remove) */
  const quickRemove = safeClosest(e.target, '.js-list-remove');
  if (quickRemove){
    const { brand, model, resType, resLoc } = quickRemove.dataset;
    const keyStr = `${unescapeHtml(brand)}||${unescapeHtml(model)}||${unescapeHtml(resType)}||${unescapeHtml(resLoc)}`;
    const targetRow = window.__APP.dom.all('#selectedFansList .fan-item')
      .find(div=>div.getAttribute('data-map') === keyStr);
    if (!targetRow){ showInfo('该数据已不在图表中'); syncQuickActionButtons(); return; }
    const key = targetRow.getAttribute('data-fan-key');
    if (!key){ showError('未找到可移除的条目'); return; }
    showLoading('op','移除中...');
    try {
      const data = await apiPost('/api/remove_fan',{ fan_key:key });
      processState(data,'已移除');
      scheduleAdjust();
    } catch(err){ hideLoading('op'); showError('移除失败: '+err.message); }
    return;
  }

  /* 快速添加 (ranking/search/rating/likes) */
  const picker = ['.js-ranking-add','.js-search-add','.js-rating-add','.js-likes-add'];
  for (const sel of picker){
    // 原有委托监听内：
    // ...
    const btn = safeClosest(e.target, sel);
    if (btn){
      const key = mapKeyFromDataset(btn.dataset);
      if (selectedMapSet.has(key)){ showInfo('该数据已添加'); syncQuickActionButtons(); return; }
      if (!ensureCanAdd()) return;
      showLoading('op','添加中...');
      try {
        const { brand, model, resType, resLoc } = btn.dataset;
        const rl = unescapeHtml(resLoc);
        const resLocToSend = (rl === '无') ? '' : rl;  // 空值 -> ''
        const data = await apiPost('/api/add_fan',{
          brand: unescapeHtml(brand),
          model: unescapeHtml(model),
          res_type: unescapeHtml(resType),
          res_loc: resLocToSend
        });
        processState(data,'添加成功');
        scheduleAdjust();
        if (data && data.success) maybeAutoOpenSidebarOnAdd();
      } catch(err){ hideLoading('op'); showError('添加失败: '+err.message); }
      return;
    }
  }

  /* 从已选列表移除 */
  const removeBtn = safeClosest(e.target, '.js-remove-fan');
  if (removeBtn){
    showLoading('op','移除中...');
    try {
      const data = await apiPost('/api/remove_fan',{ fan_key: removeBtn.dataset.fanKey });
      processState(data,'已移除');
      scheduleAdjust();
    } catch(err){ hideLoading('op'); showError('移除失败: '+err.message); }
    return;
  }

  /* 恢复 */
  const restoreBtn = safeClosest(e.target,'.js-restore-fan');
  if (restoreBtn){
    const fanKey = restoreBtn.dataset.fanKey;
    if (selectedKeySet.has(fanKey)){
      const row = restoreBtn.closest('.fan-item');
      if (row) row.remove();
      showInfo('该数据已在图表中，已从最近移除列表移除');
      return;
    }
    showLoading('op','恢复中...');
    try {
      const data = await apiPost('/api/restore_fan',{ fan_key: fanKey });
      processState(data,'已恢复');
      scheduleAdjust();
    } catch(err){ hideLoading('op'); showError('恢复失败: '+err.message); }
    return;
  }

  /* 清空确认交互 */
  if (e.target.id === 'clearAllBtn'){
    const state = e.target.getAttribute('data-state') || 'normal';
    if (state === 'normal'){
      clearAllBtn.setAttribute('data-state','confirming');
      clearAllBtn.innerHTML = `
        <div class="clear-confirm-wrapper">
          <button id="confirmClearAll" class="bg-red-600 text-white hover:bg-red-700">确认</button>
          <button id="cancelClearAll" class="bg-gray-400 text-white hover:bg-gray-500">取消</button>
        </div>`;
      scheduleAdjust();
    }
    return;
  }
  if (e.target.id === 'cancelClearAll'){
    clearAllBtn.setAttribute('data-state','normal');
    clearAllBtn.textContent='移除所有';
    scheduleAdjust();
    return;
  }
  if (e.target.id === 'confirmClearAll'){
    showLoading('op','清空中...');
    try {
      const data = await apiPost('/api/clear_all',{});
      processState(data,'已全部移除');
    } catch(err){ hideLoading('op'); showError('清空失败: '+err.message); }
    finally {
      clearAllBtn.setAttribute('data-state','normal');
      clearAllBtn.textContent='移除所有';
      scheduleAdjust();
    }
    return;
  }
});

/* =========================================================
   添加表单提交
   ========================================================= */
if (fanForm){
  fanForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const brand = brandSelect.value.trim();
    const model = modelSelect.value.trim();
    const res_type = resTypeSelect.value.trim();
    let res_loc = resLocSelect.value.trim();

    if (!brand || !model){ showError('请先选择品牌与型号'); return; }
    if (!res_type){ showError('请选择风阻类型'); return; }

    // 空载：固定使用“无”
    if (res_type === '空载') {
      res_loc = '无';
    }

    if (!res_loc) res_loc='全部'; // 非空载场景仍允许“全部”表示不筛位置

    // 既不是类型=全部，也不是位置=全部 才做精确重复校验
    if (res_type !== '全部' && res_loc !== '全部'){
      const mapKey = `${brand}||${model}||${res_type}||${res_loc}`;
      if (selectedMapSet.has(mapKey)){ showInfo('该数据已添加'); return; }
    }

    if (!ensureCanAdd()) return;
    showLoading('op','添加中...');
    try {
      // 提交前把“无”转成空串，后端据此做空值筛选
      const res_loc_payload = (res_loc === '无') ? '' : res_loc;
      const data = await apiPost('/api/add_fan',{ brand, model, res_type, res_loc: res_loc_payload });
      processState(data, data.error_message?'':'添加成功');
      scheduleAdjust();
      if (data && data.success) maybeAutoOpenSidebarOnAdd();
    } catch(err){ hideLoading('op'); showError('添加失败: '+err.message); }
  });
}

/* =========================================================
   选中数量与上限判断
   ========================================================= */
const MAX_ITEMS = Number(window.APP_CONFIG.maxItems || 0);
function currentSelectedCount(){
  return selectedKeySet.size || parseInt(selectedCountEl?.textContent||'0',10);
}
function ensureCanAdd(countToAdd=1){
  if (!MAX_ITEMS) return true;
  const curr = currentSelectedCount();
  if (curr + countToAdd > MAX_ITEMS){ showInfo(`已达上限（${MAX_ITEMS})`); return false; }
  return true;
}


/* =========================================================
   表格跑马灯（右侧 & 侧栏）
   ========================================================= */
function prepareMarqueeCells(tbody, indexes){
  if (!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.forEach(tr=>{
    const cells = Array.from(tr.children);
    indexes.forEach(i=>{
      const td = cells[i];
      if (!td) return;
      if (!td.classList.contains('marquee-cell')){
        td.classList.add('marquee-cell','nowrap');
        const inner = document.createElement('span');
        inner.className='marquee-inner';
        inner.innerHTML=td.innerHTML;
        td.innerHTML='';
        td.appendChild(inner);
      }
    });
  });
}
function wrapMarqueeForExistingTables(){
  const queriesTbody = document.querySelector('#queries-panel tbody');
  if (queriesTbody) prepareMarqueeCells(queriesTbody,[1,2,3,4]);
  if (searchAirflowTbody?.children.length>0) prepareMarqueeCells(searchAirflowTbody,[0,1,2,3]);
  if (searchLikesTbody?.children.length>0) prepareMarqueeCells(searchLikesTbody,[0,1,2,3]);
}
function startRowMarquee(tr){
  const speed=60;
  tr.querySelectorAll('.marquee-cell .marquee-inner').forEach(inner=>{
    const td = inner.parentElement;
    const delta = inner.scrollWidth - td.clientWidth;
    if (delta > 6){
      const duration = (delta / speed).toFixed(2);
      inner.style.transition = `transform ${duration}s linear`;
      inner.style.transform = `translateX(-${delta}px)`;
    }
  });
}
function stopRowMarquee(tr){
  tr.querySelectorAll('.marquee-cell .marquee-inner').forEach(inner=>{
    inner.style.transition='transform .35s ease';
    inner.style.transform='translateX(0)';
  });
}
document.addEventListener('mouseenter',(e)=>{
  const tr = safeClosest(e.target, '#right-panel-wrapper .ranking-table tbody tr');
  if (!tr) return;
  startRowMarquee(tr);
}, true);
document.addEventListener('mouseleave',(e)=>{
  const tr = safeClosest(e.target, '#right-panel-wrapper .ranking-table tbody tr');
  if (!tr) return;
  stopRowMarquee(tr);
}, true);

/* 侧栏行跑马灯 */
function prepareSidebarMarquee(){
  window.__APP.dom.all('#sidebar .fan-item .truncate').forEach(container=>{
    if (container.querySelector('.sidebar-marquee-inner')) return;
    const inner = document.createElement('span');
    inner.className='sidebar-marquee-inner';
    inner.innerHTML = container.innerHTML;
    container.innerHTML='';
    container.appendChild(inner);
  });
}
prepareSidebarMarquee();
const SIDEBAR_SCROLL_SPEED=60;
function startSidebarMarquee(row){
  const container = row.querySelector('.truncate');
  const inner = row.querySelector('.sidebar-marquee-inner');
  if (!container || !inner) return;
  const delta = inner.scrollWidth - container.clientWidth;
  if (delta > 6){
    const duration = (delta / SIDEBAR_SCROLL_SPEED).toFixed(2);
    inner.style.transition=`transform ${duration}s linear`;
    inner.style.transform=`translateX(-${delta}px)`;
  }
}
function stopSidebarMarquee(row){
  const inner = row.querySelector('.sidebar-marquee-inner');
  if (!inner) return;
  inner.style.transition='transform .35s ease';
  inner.style.transform='translateX(0)';
}
document.addEventListener('mouseenter',(e)=>{
  const row = safeClosest(e.target, '#sidebar .fan-item');
  if (!row) return;
  startSidebarMarquee(row);
}, true);
document.addEventListener('mouseleave',(e)=>{
  const row = safeClosest(e.target, '#sidebar .fan-item');
  if (!row) return;
  stopSidebarMarquee(row);
}, true);


// 新增：最近点赞场景行的跑马灯（与侧栏/表格分开，互不影响）
function prepareRecentLikesMarquee(){
  document.querySelectorAll('#recentLikesList .scenario-row .scenario-text').forEach(container=>{
    if (container.querySelector('.recent-marquee-inner')) return;
    const inner = document.createElement('span');
    inner.className = 'recent-marquee-inner';
    inner.textContent = container.textContent;
    container.textContent = '';
    container.appendChild(inner);
  });
}

const RECENT_LIKES_SCROLL_SPEED = 60; // px/s，与其它区块一致

function startRecentLikesMarquee(row){
  const container = row.querySelector('.scenario-text');
  const inner = row.querySelector('.recent-marquee-inner');
  if (!container || !inner) return;
  const delta = inner.scrollWidth - container.clientWidth;
  if (delta > 6){
    const duration = (delta / RECENT_LIKES_SCROLL_SPEED).toFixed(2);
    inner.style.transition = `transform ${duration}s linear`;
    inner.style.transform  = `translateX(-${delta}px)`;
  }
}
function stopRecentLikesMarquee(row){
  const inner = row.querySelector('.recent-marquee-inner');
  if (!inner) return;
  inner.style.transition = 'transform .35s ease';
  inner.style.transform  = 'translateX(0)';
}

// 委托监听：进入行开始左移，离开行复位
document.addEventListener('mouseenter', (e)=>{
  const row = safeClosest(e.target, '#recentLikesList .scenario-row');
  if (!row) return;
  startRecentLikesMarquee(row);
}, true);

document.addEventListener('mouseleave', (e)=>{
  const row = safeClosest(e.target, '#recentLikesList .scenario-row');
  if (!row) return;
  stopRecentLikesMarquee(row);
}, true);

/* =========================================================
   底部面板自动高度（节流后的 scheduleAdjust 驱动）
   ========================================================= */
(function(){
  const CFG = { MIN_BOTTOM_PX:140, MAX_RATIO:0.72, MIN_TOP_SPACE_PX:260 };
  const px = (v)=>Number.parseFloat(v)||0;
  const hRect = (el)=> (el ? Math.ceil(el.getBoundingClientRect().height):0);
  const isHidden = (el)=>!el || el.classList.contains('hidden');

  function computeDesiredBottomHeight(){
    const bottom = document.getElementById('bottom-panel');
    const content = bottom?.querySelector('.sidebar-panel-content');
    const title = content?.querySelector('h2');
    const list = document.getElementById('selectedFansList');
    const footer = document.getElementById('clearAllContainer');
    const winH = window.innerHeight;
    const titleH = hRect(title);
    const titleMB = title ? px(getComputedStyle(title).marginBottom):0;
    const contentPT = content ? px(getComputedStyle(content).paddingTop):0;
    const footerH = !isHidden(footer)? hRect(footer):0;

    let rows=0,rowH=56,gapY=0,listPT=0,listPB=0;
    if (list){
      const items = list.querySelectorAll('.fan-item');
      rows = items.length;
      if (rows>0){
        rowH = hRect(items[0]);
        if (rows>1) gapY = px(getComputedStyle(items[1]).marginTop);
      }
      const ls = getComputedStyle(list);
      listPT = px(ls.paddingTop); listPB = px(ls.paddingBottom);
    }
    const listContentH = rows>0 ? rows*rowH + Math.max(0,rows-1)*gapY + listPT + listPB : 0;
    const chromeH = contentPT + titleH + titleMB + footerH;

    const maxBottomByRatio = winH * CFG.MAX_RATIO;
    const maxBottomByTopReserve = winH - CFG.MIN_TOP_SPACE_PX;
    const maxBottom = Math.max(CFG.MIN_BOTTOM_PX, Math.min(maxBottomByRatio, maxBottomByTopReserve));

    const maxListViewport = Math.max(0, maxBottom - chromeH);
    const listViewportH = Math.min(listContentH, maxListViewport);
    const ideal = chromeH + listViewportH;
    const desired = Math.max(Math.min(ideal, maxBottom), Math.min(CFG.MIN_BOTTOM_PX, maxBottom));
    return Math.round(desired);
  }

  window.adjustBottomPanelAuto = function adjustBottomPanelAuto(){
    try { if (typeof userAdjustedVertical !== 'undefined' && userAdjustedVertical) return; } catch {}
    const bottomPanel = document.getElementById('bottom-panel');
    const topPanel = document.getElementById('top-panel');
    if (!bottomPanel || !topPanel) return;
    const h = computeDesiredBottomHeight();
    bottomPanel.style.flex = `0 0 ${h}px`;
    topPanel.style.flex ='1 1 auto';
    requestAnimationFrame(()=> {
      if (typeof syncTopTabsViewportHeight === 'function') syncTopTabsViewportHeight();
    });
  };

  (function(){
    const list = document.getElementById('selectedFansList');
    if (list && 'ResizeObserver' in window){
      const ro = new ResizeObserver(()=>{
        try { if (typeof userAdjustedVertical !== 'undefined' && userAdjustedVertical) return; } catch(_){}
        scheduleAdjust();
      });
      ro.observe(list);
    }
  })();

  const footer = document.getElementById('clearAllContainer');
  if (footer && 'ResizeObserver' in window){
    const ro = new ResizeObserver(()=>{
      if (typeof userAdjustedVertical !== 'undefined' && userAdjustedVertical) return;
      requestAnimationFrame(()=>window.adjustBottomPanelAuto());
    });
    ro.observe(footer);
  }
  window.addEventListener('resize', ()=>{
    if (typeof userAdjustedVertical !== 'undefined' && userAdjustedVertical) return;
    requestAnimationFrame(()=>window.adjustBottomPanelAuto());
  });
})();

/* =========================================================
   Segment 切换（查询榜 / 好评榜 + 搜索子段）
   ========================================================= */
document.addEventListener('click',(e)=>{
  const btn = safeClosest(e.target,'.seg-btn');
  if (!btn) return;
  const seg = btn.closest('.seg'); if (!seg) return;
  const targetId = btn.dataset.target;
  seg.querySelectorAll('.seg-btn').forEach(b=>b.classList.toggle('is-active', b===btn));
  seg.setAttribute('data-active', targetId);
  const paneId = seg.dataset.paneId;
  const pane = paneId ? document.getElementById(paneId):null;
  if (pane) pane.querySelectorAll('.rank-panel').forEach(p=>p.classList.toggle('active', p.id===targetId));
  if (targetId === 'likes-panel') loadLikesIfNeeded();
});

(function initRightSegSwitchLikeXAxis() {
  const segs = document.querySelectorAll('#rightSubsegContainer .seg');
  if (!segs.length) return;

  segs.forEach(seg => {
    const thumb = seg.querySelector('.seg-thumb');
    const btns = seg.querySelectorAll('.seg-btn');
    if (!thumb || btns.length !== 2) return;

    let dragging = false;
    let startX = 0;
    let basePercent = 0; // 0 或 100（起始在左/右）
    let lastPercent = 0;

    function activeIsRight() {
      const act = seg.getAttribute('data-active') || '';
      // 两个控件的右侧目标都以 likes-panel 结尾：likes-panel / search-likes-panel
      return act.endsWith('likes-panel');
    }

    function pointInThumb(clientX, clientY) {
      const r = thumb.getBoundingClientRect();
      return clientX >= r.left && clientX <= r.right && clientY >= r.top && clientY <= r.bottom;
    }

    function start(e) {
      const cx = (e.touches ? e.touches[0].clientX : e.clientX) || 0;
      const cy = (e.touches ? e.touches[0].clientY : e.clientY) || 0;
      // 仅当起点在 thumb 区域内才进入拖拽
      if (!pointInThumb(cx, cy)) return;

      dragging = true;
      startX = cx;
      basePercent = activeIsRight() ? 100 : 0;
      lastPercent = basePercent;
      thumb.style.transition = 'none';
      if (e.cancelable) e.preventDefault();
    }

    function move(e) {
      if (!dragging) return;
      const cx = (e.touches ? e.touches[0].clientX : e.clientX) || 0;
      const dx = cx - startX;
      const w = thumb.getBoundingClientRect().width || 1; // translateX(%) 以自身宽度为基
      let percent = basePercent + (dx / w) * 100;
      percent = Math.max(0, Math.min(100, percent));
      lastPercent = percent;
      thumb.style.transform = `translateX(${percent}%)`;
      if (e.cancelable) e.preventDefault();
    }

    function end() {
      if (!dragging) return;
      dragging = false;

      const goRight = lastPercent >= 50;
      const targetBtn = goRight ? btns[1] : btns[0];

      // 清理内联样式，交给现有 CSS 根据 data-active 定位
      thumb.style.transition = '';
      thumb.style.transform = '';

      // 触发按钮 click，复用现有切换/懒加载/ARIA 逻辑
      targetBtn.click();
    }

    // 改为在 seg 容器上接收起始事件，避免被按钮挡住
    seg.addEventListener('mousedown', start);
    document.addEventListener('mousemove', move, { passive: false });
    document.addEventListener('mouseup', end);

    seg.addEventListener('touchstart', start, { passive: false });
    document.addEventListener('touchmove', move, { passive: false });
    document.addEventListener('touchend', end);
  });
})();

/* =========================================================
   scheduleAdjust (P0-3 节流版)
   ========================================================= */
let _adjustQueued = false;
function scheduleAdjust(){
  // 拖拽过程中或用户已手动锁定时都跳过
  if (window.__VERT_DRAGGING) return;
  if (userAdjustedVertical)   return;
  if (_adjustQueued) return;
  _adjustQueued = true;
  requestAnimationFrame(()=>{
    _adjustQueued = false;
    window.adjustBottomPanelAuto && window.adjustBottomPanelAuto();
  });
}

/* =========================================================
   初始数据获取
   ========================================================= */
fetch('/api/state')
  .then(r=>r.json())
  .then(d=>processState(d,''))
  .catch(()=>{});

/* 初始右侧子段显示状态 */
updateRightSubseg(localStorage.getItem('activeTab_right-panel') || 'top-queries');

(function autoScrollToChartOnShare(){
  try {
    const usp = new URLSearchParams(window.location.search);
    if (usp.get('share_loaded') === '1') {
      window.addEventListener('load', () => {
        setTimeout(() => {
          const el = document.getElementById('chart-settings');
            if (el) {
              el.scrollIntoView({ behavior:'smooth', block:'center' });
            }
        }, 120);
      });
    }
  } catch(_) {}
})();

/* =========================================================
   添加表单选项提交后补充
   ========================================================= */
function scheduleInitListPadding(){
  const list = document.querySelector('#selectedFansList');
  if (list) list.style.paddingBottom='var(--content-bottom-gap)';
}
scheduleInitListPadding();

/* 图表窗口 Resize */
window.addEventListener('resize', ()=> { if (!isCollapsed) resizeChart(); });

/* =========================================================
   顶部 Scroll Snap 分页（仅处理存储/回滚）
   ========================================================= */
   (function initSidebarTopSnap(){
  const container = document.getElementById('sidebar-top-container');
  const nav = document.querySelector('.tab-nav[data-tab-group="sidebar-top"]');
  if (!container || !nav) return;

  const tabs = Array.from(nav.querySelectorAll('.tab-nav-item'));

  function go(idx){
    const w = container.clientWidth;
    container.scrollTo({ left: w * idx, behavior: 'smooth' });
  }

  nav.addEventListener('click', e => {
    const item = e.target.closest('.tab-nav-item');
    if (!item) return;
    const idx = tabs.indexOf(item);
    if (idx < 0) return;
    go(idx);
    tabs.forEach((t,i)=>t.classList.toggle('active', i===idx));
    localStorage.setItem('activeTab_sidebar-top', item.dataset.tab);
  });

  container.addEventListener('scroll', () => {
    clearTimeout(container._snapTimer);
    container._snapTimer = setTimeout(() => {
      const w = container.clientWidth || 1;
      const idx = Math.round(container.scrollLeft / w);
      tabs.forEach((t,i)=>t.classList.toggle('active', i===idx));
    }, 80);
  });

  // 初始定位
  const saved = localStorage.getItem('activeTab_sidebar-top');
  let idx = 0;
  if (saved) {
    const found = tabs.findIndex(t => t.dataset.tab === saved);
    if (found >= 0) idx = found;
  }
  requestAnimationFrame(() => {
    container.scrollLeft = container.clientWidth * idx;
    tabs.forEach((t,i)=>t.classList.toggle('active', i===idx));
  });
})();

(function initLeftPanelSnap() {
  const container = document.getElementById('left-panel-container');
  const nav = document.querySelector('.tab-nav[data-tab-group="left-panel"]');
  if (!container || !nav) return;

  const tabs = Array.from(nav.querySelectorAll('.tab-nav-item'));

  function go(idx) {
    const w = container.clientWidth || 1;
    container.scrollTo({ left: w * idx, behavior: 'smooth' });
  }

  // 点击页签 -> 滑动到对应页
  nav.addEventListener('click', e => {
    const item = e.target.closest('.tab-nav-item');
    if (!item) return;
    const idx = tabs.indexOf(item);
    if (idx < 0) return;
    go(idx);
    tabs.forEach((t, i) => t.classList.toggle('active', i === idx));
    localStorage.setItem('activeTab_left-panel', item.dataset.tab);
  });

  // 滑动时根据 scrollLeft 同步激活态与记忆
  container.addEventListener('scroll', () => {
    clearTimeout(container._snapTimer);
    container._snapTimer = setTimeout(() => {
      const w = container.clientWidth || 1;
      const idx = Math.round(container.scrollLeft / w);
      tabs.forEach((t, i) => t.classList.toggle('active', i === idx));
      const activeTab = tabs[idx]?.dataset.tab;
      if (activeTab) localStorage.setItem('activeTab_left-panel', activeTab);
    }, 80);
  });

  // 初始定位到上次的页签
  const saved = localStorage.getItem('activeTab_left-panel');
  let idx = 0;
  if (saved) {
    const found = tabs.findIndex(t => t.dataset.tab === saved);
    if (found >= 0) idx = found;
  }
  requestAnimationFrame(() => {
    container.scrollLeft = container.clientWidth * idx;
    tabs.forEach((t, i) => t.classList.toggle('active', i === idx));
  });
})();

(function initTopSnapLazyLoadOnScroll(){
  const container = document.getElementById('sidebar-top-container');
  const nav = document.querySelector('.tab-nav[data-tab-group="sidebar-top"]');
  if (!container || !nav) return;

  const tabs = Array.from(nav.querySelectorAll('.tab-nav-item'));
  const tabNameByIndex = i => tabs[i]?.dataset.tab;
  let debounceTimer = null;

  function finalize() {
    const w = container.clientWidth || 1;
    const idx = Math.round(container.scrollLeft / w);
    const tabName = tabNameByIndex(idx);
    if (tabName === 'recent-liked' && typeof loadRecentLikesIfNeeded === 'function') {
      loadRecentLikesIfNeeded();
    }
  }

  container.addEventListener('scroll', () => {
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(finalize, 90);
  });

  requestAnimationFrame(() => finalize());
})();

/* ==== P2-8 A11y: 焦点陷阱工具 ==== */
const a11yFocusTrap = (function(){
  let container = null;
  let lastFocused = null;
  let bound = false;

  function focusableElements(root){
    return Array.from(root.querySelectorAll(
      'a[href],button:not([disabled]),input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex="-1"])'
    )).filter(el => el.offsetParent !== null);
  }

  function handleKey(e){
    if (e.key !== 'Tab') return;
    if (!container) return;
    const list = focusableElements(container);
    if (!list.length) {
      e.preventDefault();
      container.focus();
      return;
    }
    const first = list[0];
    const last = list[list.length - 1];
    if (e.shiftKey) {
      if (document.activeElement === first) {
        e.preventDefault();
        last.focus();
      }
    } else {
      if (document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }
  }

  return {
    activate(root){
      if (!root) return;
      container = root;
      lastFocused = document.activeElement;
      const list = focusableElements(root);
      (list[0] || root).focus({ preventScroll:true });
      if (!bound){
        document.addEventListener('keydown', handleKey, true);
        bound = true;
      }
    },
    deactivate(){
      if (bound){
        document.removeEventListener('keydown', handleKey, true);
        bound = false;
      }
      if (lastFocused && typeof lastFocused.focus === 'function') {
        lastFocused.focus({ preventScroll:true });
      }
      container = null;
      lastFocused = null;
    }
  };
})();

/* ==== P2-8 A11y: Tabs / Segmented 控件 ARIA + 键盘导航 ==== */
(function initA11yTabs(){
  const TAB_GROUP_SELECTOR = '.tab-nav[data-tab-group]';
  const SEG_SELECTOR = '.seg[data-active]';

  function upgradeTabGroup(nav){
    if (nav.getAttribute('role') === 'tablist') return;
    nav.setAttribute('role','tablist');
    const group = nav.dataset.tabGroup || '';
    const items = Array.from(nav.querySelectorAll('.tab-nav-item'));
    items.forEach((item, idx) => {
      const tabId = item.id || (`tab-${group}-${idx}`);
      item.id = tabId;
      item.setAttribute('role','tab');
      // 关联面板（如果面板在 DOM 中具有 tab 名称）
      const panelName = item.dataset.tab;
      const panel = document.getElementById(`${panelName}-pane`) || document.getElementById(`${panelName}-panel`);
      if (panel) {
        const panelId = panel.id;
        item.setAttribute('aria-controls', panelId);
        panel.setAttribute('role','tabpanel');
        panel.setAttribute('aria-labelledby', tabId);
      }
      item.setAttribute('tabindex', item.classList.contains('active') ? '0':'-1');
      item.setAttribute('aria-selected', item.classList.contains('active') ? 'true':'false');
    });
  }

  function syncActive(nav){
    const items = Array.from(nav.querySelectorAll('.tab-nav-item'));
    items.forEach(it => {
      const active = it.classList.contains('active');
      it.setAttribute('tabindex', active ? '0':'-1');
      it.setAttribute('aria-selected', active ? 'true':'false');
    });
  }

  function handleKey(e){
    const item = e.target.closest('.tab-nav-item[role="tab"]');
    if (!item) return;
    const nav = item.closest('[role="tablist"]');
    if (!nav) return;
    if (!['ArrowLeft','ArrowRight','Home','End'].includes(e.key)) return;

    const items = Array.from(nav.querySelectorAll('.tab-nav-item[role="tab"]'));
    const currentIndex = items.indexOf(item);
    let nextIndex = currentIndex;
    if (e.key === 'ArrowRight') nextIndex = (currentIndex + 1) % items.length;
    else if (e.key === 'ArrowLeft') nextIndex = (currentIndex - 1 + items.length) % items.length;
    else if (e.key === 'Home') nextIndex = 0;
    else if (e.key === 'End') nextIndex = items.length - 1;

    if (nextIndex !== currentIndex) {
      e.preventDefault();
      items[nextIndex].click();   // 复用现有 click 逻辑
      items[nextIndex].focus();
      syncActive(nav);
    }
  }

  // 初始升级
  document.querySelectorAll(TAB_GROUP_SELECTOR).forEach(upgradeTabGroup);
  // 监听点击后同步 ARIA
  document.addEventListener('click', e=>{
    const item = e.target.closest('.tab-nav-item');
    if (!item) return;
    const nav = item.closest(TAB_GROUP_SELECTOR);
    if (nav) syncActive(nav);
  });
  document.addEventListener('keydown', handleKey);

  /* Segmented 控件（.seg）辅助角色 */
  document.querySelectorAll(SEG_SELECTOR).forEach(seg=>{
    if (!seg.querySelector('.seg-btn')) return;
    if (!seg.hasAttribute('role')) seg.setAttribute('role','tablist');
    const btns = Array.from(seg.querySelectorAll('.seg-btn'));
    btns.forEach((b,i)=>{
      b.setAttribute('role','tab');
      b.setAttribute('tabindex', b.classList.contains('is-active') ? '0':'-1');
      b.setAttribute('aria-selected', b.classList.contains('is-active') ? 'true':'false');
      const id = b.id || `seg-${Math.random().toString(36).slice(2)}`;
      b.id = id;
    });
    seg.addEventListener('click', ()=> {
      btns.forEach(b=>{
        const act = b.classList.contains('is-active');
        b.setAttribute('tabindex', act ? '0':'-1');
        b.setAttribute('aria-selected', act ? 'true':'false');
      });
    });
    seg.addEventListener('keydown', e=>{
      if (!['ArrowLeft','ArrowRight','Home','End'].includes(e.key)) return;
      const activeIndex = btns.findIndex(b=>b.classList.contains('is-active'));
      let idx = activeIndex;
      if (e.key === 'ArrowRight') idx = (activeIndex + 1) % btns.length;
      else if (e.key === 'ArrowLeft') idx = (activeIndex - 1 + btns.length) % btns.length;
      else if (e.key === 'Home') idx = 0;
      else if (e.key === 'End') idx = btns.length - 1;
      if (idx !== activeIndex) {
        e.preventDefault();
        btns[idx].click();
        btns[idx].focus();
      }
    });
  });
})();

/* ==== P1-6 模块注册（最小骨架） ==== */
window.__APP.modules = {
  overlay: {
    open: window.overlayOpenSidebar,
    close: window.overlayCloseSidebar,
    toggle: window.overlayToggleSidebar
  },
  gesture: {
    ensureZone: window.ensureGestureZone || function(){}
  },
  layout: {
    scheduleAdjust,
    adjustBottomAuto: window.adjustBottomPanelAuto
  },
  search: {
    render: typeof renderSearchResults === 'function' ? renderSearchResults : function(){},
    cache: window.__APP.cache
  },
  rankings: {
    reloadTopRatings: typeof reloadTopRatings === 'function' ? reloadTopRatings : function(){},
    loadLikesIfNeeded: typeof loadLikesIfNeeded === 'function' ? loadLikesIfNeeded : function(){}
  },
  state: {
    processState: typeof processState === 'function' ? processState : function(){}
  },
  theme: {
    setTheme: typeof setTheme === 'function' ? setTheme : function(){}
  },
  chart: {
    postChartData: typeof postChartData === 'function' ? postChartData : function(){},
    resizeChart: typeof resizeChart === 'function' ? resizeChart : function(){}
  }
};

  (function setRealScrollbarWidth(){
    function measure(){
      try{
        const box = document.createElement('div');
        box.style.cssText = 'position:absolute;top:-9999px;left:-9999px;width:120px;height:120px;overflow:scroll;visibility:hidden;';
        document.body.appendChild(box);
        const sbw = Math.max(0, box.offsetWidth - box.clientWidth) || 0; // 覆盖式滚动条返回 0
        document.documentElement.style.setProperty('--sbw', sbw + 'px');
        document.documentElement.classList.toggle('overlay-scrollbars', sbw === 0);
        box.remove();
      }catch(e){}
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', measure, { once:true });
    } else {
      measure();
    }
    // 某些安卓设备横竖屏/窗口变化时滚动条表现会变，延迟重测更稳
    const remeasure = () => setTimeout(measure, 60);
    window.addEventListener('orientationchange', remeasure);
    window.addEventListener('resize', remeasure);
  })();

  (function initSortValueUnlockMinimal() {
  const select = document.getElementById('sortBySelect');   // none | rpm | noise
  const input  = document.getElementById('sortValueInput'); // body 已统一 min/max/step
  if (!select || !input) return;

  function apply() {
    const none = (select.value === 'none');
    input.disabled = none;
    if (none) input.value = '';
  }

  select.addEventListener('change', apply);
  apply(); // 首次同步服务端初始状态
})();

  // 获取查询次数
  function loadQueryCount() {
      fetch('/api/query_count')
          .then(response => response.json())
          .then(data => {
              document.getElementById('query-count').textContent = data.count;
          })
          .catch(error => {
              console.error('获取查询次数失败:', error);
          });
  }
  
  // 页面加载时执行
  document.addEventListener('DOMContentLoaded', loadQueryCount);

  function applyRecentLikesTitleMask() {
    const groups = document.querySelectorAll('#recentLikesList .recent-like-group');
    groups.forEach(g => {
      const titleWrap = g.querySelector('.group-header .title-wrap');
      const titleBox  = titleWrap?.querySelector('.truncate');
      if (!titleWrap || !titleBox) return;
      // 可见标题宽度（容器宽度即为可见宽度，因溢出被裁切）
      const w = Math.max(0, Math.ceil(titleBox.getBoundingClientRect().width));
      titleWrap.style.setProperty('--title-w', w + 'px');
      // 如需调渐隐长度：
      // titleWrap.style.setProperty('--fade-w', '28px');
    });
  }
  
  /* 在 rebuildRecentLikes 渲染后执行一次测量 */
  if (typeof window.rebuildRecentLikes === 'function' && !window.__RECENT_TITLE_MASK_PATCHED__) {
    window.__RECENT_TITLE_MASK_PATCHED__ = true;
    const _orig = window.rebuildRecentLikes;
    window.rebuildRecentLikes = function(list){
      _orig(list);
      requestAnimationFrame(applyRecentLikesTitleMask);
    };
  }
  
  /* 侧栏尺寸变化时重算（轻微防抖） */
  let __titleMaskRaf = null;
  window.addEventListener('resize', () => {
    if (__titleMaskRaf) cancelAnimationFrame(__titleMaskRaf);
    __titleMaskRaf = requestAnimationFrame(applyRecentLikesTitleMask);
  });

  window.addEventListener('message', (e) => {
    if (e.origin !== window.location.origin) return;
    const { type, payload } = e.data || {};

    if (type === 'chart:ready') {
      chartFrameReady = true;
      flushChartQueue();
      // 若队列为空但已有 lastChartData（例如 ready 之前没有触发过 postChartData），补发一次
      if (lastChartData && !chartMessageQueue.length){
        postChartData(lastChartData);
      }
      return;
    }

    if (type === 'chart:xaxis-type-changed') {
      const next = (payload?.x_axis_type === 'noise') ? 'noise_db' : (payload?.x_axis_type || 'rpm');
      if (next !== frontXAxisType) {
        frontXAxisType = next;
        try { localStorage.setItem('x_axis_type', frontXAxisType); } catch(_) {}
        if (lastChartData) postChartData(lastChartData);
      }
    }
  });

    // === 新增：记录用户是否点击过侧栏按钮（本地标记） ===
    const LS_KEY_SIDEBAR_TOGGLE_CLICKED = 'sidebar_toggle_clicked';
    function markSidebarToggleClicked(){
      try { localStorage.setItem(LS_KEY_SIDEBAR_TOGGLE_CLICKED, '1'); } catch(_) {}
    }
    function userHasClickedSidebarToggle(){
      try { return localStorage.getItem(LS_KEY_SIDEBAR_TOGGLE_CLICKED) === '1'; } catch(_) { return false; }
    }
    // 当用户未点击过侧栏按钮且发生“添加成功”时，才自动弹出侧栏
    function maybeAutoOpenSidebarOnAdd(){
      if (userHasClickedSidebarToggle()) return;
      expandSidebarIfCollapsed();
    }

    (function initVisitStartMinimal(){
      // 同一标签页只上报一次（刷新不重复）
      try { if (sessionStorage.getItem('visit_started') === '1') return; } catch(_) {}

      const payload = {
        screen_w: (screen && screen.width) || null,
        screen_h: (screen && screen.height) || null,
        device_pixel_ratio: window.devicePixelRatio || null,
        language: (navigator.languages && navigator.languages[0]) || navigator.language || null,
        is_touch: ('ontouchstart' in window) || (navigator.maxTouchPoints > 0)
      };

      fetch('/api/visit_start', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload),
        keepalive: true
      }).catch(()=>{}).finally(()=>{
        try { sessionStorage.setItem('visit_started','1'); } catch(_){}
      });
    })();

    (function initScenarioCascading(){
      const form = document.getElementById('searchForm');
      if (!form) return;
      const typeSel = form.querySelector('select[name="search_res_type"]');
      const locSel  = form.querySelector('select[name="search_res_loc"]');
        
      if (!typeSel || !locSel) return;
        
      function setLocOptions(options, enable){
        const prev = locSel.value;
        // enable=false 时提示“请先选择风阻类型”
        locSel.innerHTML = enable
          ? '<option value="">-- 选择风阻位置 --</option>'
          : '<option value="">-- 请先选择风阻类型 --</option>';
      
        (options || []).forEach(v=>{
          const o = document.createElement('option');
          o.value = v; o.textContent = v;
          locSel.appendChild(o);
        });
      
        if (enable && prev && options && options.includes(prev)) {
          locSel.value = prev;
        } else if (!enable) {
          locSel.value = '';
        }
        locSel.disabled = !enable;
      }
    
      async function refreshLocByType(rt){
        if (!rt){
          setLocOptions([], false);
          return;
        }
        if (rt === '空载'){
          locSel.innerHTML = '<option value="无" selected>无</option>';
          locSel.disabled = true;
          return;
        }
        try{
          const rsp = await fetch(`/get_resistance_locations_by_type/${encodeURIComponent(rt)}`);
          const list = await rsp.json();
          setLocOptions(Array.isArray(list)?list:[], true);
        }catch(_){
          setLocOptions([], false);
        }
      }
    
      // 初始：明确设置占位并锁定，然后按已选类型加载
      locSel.innerHTML = '<option value="">-- 请先选择风阻类型 --</option>';
      locSel.disabled = true;
      refreshLocByType((typeSel.value || '').trim());
    
      typeSel.addEventListener('change', ()=>{
        const rt = (typeSel.value || '').trim();
        refreshLocByType(rt);
      });
    })();

  /* === Global Tooltip（避开 overflow 裁切 + 主题适配） === */
  (function initGlobalTooltip(){
    const MARGIN = 8; // 视口边缘最小间距
    let tip = null, currAnchor = null, hideTimer = null;

    function ensureTip(){
      if (tip) return tip;
      tip = document.createElement('div');
      tip.id = 'appTooltip';
      document.body.appendChild(tip);
      return tip;
    }

    function setText(html){
      ensureTip().innerHTML = html;
    }

    function placeAround(anchor, preferred='top'){
      const t = ensureTip();
      const rect = anchor.getBoundingClientRect();
      const vw = window.innerWidth, vh = window.innerHeight;

      // 先让 tooltip 可见于屏外测量尺寸
      t.style.visibility = 'hidden';
      t.dataset.show = '1';
      t.style.left = '-9999px';
      t.style.top  = '-9999px';

      const tw = t.offsetWidth, th = t.offsetHeight;

      // 选择上下位置：优先 top，放不下则 bottom
      let placement = preferred;
      const topSpace = rect.top;
      const bottomSpace = vh - rect.bottom;
      if (preferred === 'top' && topSpace < th + 12) placement = 'bottom';
      if (preferred === 'bottom' && bottomSpace < th + 12) placement = 'top';

      // 水平居中锚点，同时防止越界
      let cx = rect.left + rect.width / 2;
      cx = Math.max(MARGIN + tw/2, Math.min(vw - MARGIN - tw/2, cx));

      // 垂直位置
      let top;
      if (placement === 'top') {
        top = rect.top - th - 10; // 与锚点间隔
      } else {
        top = rect.bottom + 10;
      }

      // 应用
      t.dataset.placement = placement;
      t.style.left = `${Math.round(cx)}px`;
      t.style.top  = `${Math.round(top)}px`;
      t.style.visibility = '';
    }

    function show(anchor){
      clearTimeout(hideTimer);
      currAnchor = anchor;
      const txt = anchor.getAttribute('data-tooltip') || anchor.getAttribute('title') || '';
      // 移除原生 title 避免浏览器自带气泡
      if (anchor.hasAttribute('title')) anchor.setAttribute('data-title', anchor.getAttribute('title')), anchor.removeAttribute('title');

      setText(txt);
      placeAround(anchor, anchor.getAttribute('data-tooltip-placement') || 'top');
      ensureTip().dataset.show = '1';
    }

    function hide(immediate=false){
      const t = ensureTip();
      const doHide = () => { t.dataset.show = '0'; currAnchor = null; };
      if (immediate) return doHide();
      hideTimer = setTimeout(doHide, 60);
    }

    // 事件委托：鼠标与键盘无障碍（修复 closest 报错）
    document.addEventListener('mouseenter', (e) => {
      let node = e.target;
      // 如果是文本/注释等非元素节点，提升到父元素
      if (node && node.nodeType !== 1) node = node.parentElement;
      if (!node) return;
      // 优先使用浏览器自带 closest，失败再降级到 safeClosest
      let el = null;
      if (node && typeof node.closest === 'function') {
        try { el = node.closest('[data-tooltip]'); } catch(_) {}
      }
      if (!el) el = safeClosest(node, '[data-tooltip]');
      if (!el) return;
      show(el);
    }, true);
    document.addEventListener('mouseleave', (e) => {
      let node = e.target;
      if (node && node.nodeType !== 1) node = node.parentElement;
      if (!node) return;
      let el = null;
      if (node && typeof node.closest === 'function') {
        try { el = node.closest('[data-tooltip]'); } catch(_) {}
      }
      if (!el) el = safeClosest(node, '[data-tooltip]');
      if (!el) return;
      hide(false);
    }, true);
    
    document.addEventListener('focusin', (e)=>{
      const el = safeClosest(e.target, '[data-tooltip]');
      if (!el) return;
      show(el);
    });
    document.addEventListener('focusout', (e)=>{
      const el = safeClosest(e.target, '[data-tooltip]');
      if (!el) return;
      hide(false);
    });

    // 任意滚动容器或窗口尺寸变化时，重新定位
    const onRelayout = ()=>{ if (currAnchor && document.body.contains(currAnchor)) placeAround(currAnchor, currAnchor.getAttribute('data-tooltip-placement') || 'top'); };
    window.addEventListener('resize', onRelayout);
    window.addEventListener('scroll', onRelayout, true); // 捕获阶段，能监听任意滚动容器

    // 页面卸载时清理 title 还原（可选）
    window.addEventListener('beforeunload', ()=>{
      document.querySelectorAll('[data-title]').forEach(el=>{
        el.setAttribute('title', el.getAttribute('data-title') || '');
        el.removeAttribute('data-title');
      });
    });
  })();

  // 统一格式化场景显示（位置为空则只显示类型）
  function formatScenario(rt, rl){
  const rtype = escapeHtml(rt || '');
  const raw = rl ?? '';
  const isEmpty = (String(raw).trim() === '' || String(raw).trim() === '无');
  return isEmpty ? rtype : `${rtype}(${escapeHtml(raw)})`;
}
</script>
</body>
</html>